<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLI Span Labeler</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #4a9eff;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #3a8eef; }
        .btn-success { background: var(--success); color: #1a1a2e; }
        .btn-warning { background: var(--warning); color: #1a1a2e; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #444; color: white; }
        .btn-small { padding: 4px 10px; font-size: 0.8rem; }

        .card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .example-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .example-id {
            font-family: monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .gold-label {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .gold-label.entailment { background: #22c55e33; color: #4ade80; }
        .gold-label.neutral { background: #eab30833; color: #fbbf24; }
        .gold-label.contradiction { background: #ef444433; color: #f87171; }

        .text-section {
            margin-bottom: 20px;
        }

        .text-section.active-section {
            background: rgba(74, 158, 255, 0.05);
            border-radius: 8px;
            margin: -8px;
            padding: 8px;
            margin-bottom: 12px;
        }

        .text-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .text-section.active-section .text-label {
            color: var(--accent);
        }

        .text-content {
            line-height: 2.5;
            font-size: 1.1rem;
        }

        /* Word container for multi-label support */
        .word-container {
            display: inline-block;
            position: relative;
            margin: 2px 4px;
            vertical-align: top;
        }

        /* Subword tokens have reduced left margin to visually connect */
        .word-container.subword {
            margin-left: 0;
        }

        .word {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
            position: relative;
            z-index: 1;
        }

        /* Subword tokens get a left connector */
        .word.subword {
            padding-left: 3px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* Subword indicator */
        .word.subword::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 2px;
            background: var(--text-secondary);
            opacity: 0.5;
        }

        .word:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Keyboard focus indicator */
        .word.keyboard-focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            background: rgba(74, 158, 255, 0.2);
        }

        /* Label dots below words */
        .label-dots {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 2px;
            min-height: 8px;
        }

        .label-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .label-dot.active-label {
            width: 8px;
            height: 8px;
            box-shadow: 0 0 4px currentColor;
        }

        /* Active label highlight on word */
        .word.has-active-label {
            border-width: 2px;
            border-style: solid;
        }

        /* Color classes */
        .color-0 { background: rgba(59, 130, 246, 0.3); border-color: #3b82f6; color: #3b82f6; }
        .color-1 { background: rgba(139, 92, 246, 0.3); border-color: #8b5cf6; color: #8b5cf6; }
        .color-2 { background: rgba(6, 182, 212, 0.3); border-color: #06b6d4; color: #06b6d4; }
        .color-3 { background: rgba(34, 197, 94, 0.3); border-color: #22c55e; color: #22c55e; }
        .color-4 { background: rgba(234, 179, 8, 0.3); border-color: #eab308; color: #eab308; }
        .color-5 { background: rgba(249, 115, 22, 0.3); border-color: #f97316; color: #f97316; }
        .color-6 { background: rgba(74, 222, 128, 0.3); border-color: #4ade80; color: #4ade80; }
        .color-7 { background: rgba(251, 191, 36, 0.3); border-color: #fbbf24; color: #fbbf24; }
        .color-8 { background: rgba(248, 113, 113, 0.3); border-color: #f87171; color: #f87171; }

        .labels-section { margin-top: 20px; }

        .labels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .labels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .label-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .label-item:hover { background: rgba(0, 0, 0, 0.3); }

        .label-item.active {
            border-color: var(--accent);
            background: rgba(74, 158, 255, 0.1);
        }

        .label-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .label-name {
            flex-grow: 1;
            font-size: 0.9rem;
        }

        .label-name input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 100%;
            font-size: 0.9rem;
        }

        .label-name input:focus {
            outline: none;
            border-bottom: 1px solid var(--accent);
        }

        .label-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .label-key {
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .complexity-section { margin-top: 20px; }

        .complexity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .complexity-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .complexity-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .complexity-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .complexity-input input[type="range"] {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            -webkit-appearance: none;
            background: #333;
        }

        .complexity-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .complexity-input input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: center;
        }

        .complexity-input input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Hide number input spinners */
        .complexity-input input[type="number"]::-webkit-outer-spin-button,
        .complexity-input input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .message {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .message.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .message.error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .dataset-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .dataset-selector select {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        .instructions {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .instructions strong { color: var(--accent); }

        /* Tokenizer info badge */
        .tokenizer-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .tokenizer-badge::before {
            content: 'üî§';
        }

        /* User info badge */
        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-badge .username {
            font-weight: 600;
        }

        .user-badge .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 4px;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .user-badge .logout-btn:hover {
            opacity: 1;
            color: var(--danger);
        }

        /* Help button */
        .help-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: rgba(74, 158, 255, 0.2);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Legend for label colors */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal.modal-wide {
            max-width: 700px;
        }

        .modal.modal-tall {
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: var(--accent);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .modal-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .modal-tab:hover { color: var(--text-primary); }
        .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .modal-actions {
            margin-top: 20px;
        }

        .modal-actions .btn {
            width: 100%;
            padding: 12px;
        }

        .anonymous-note {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        /* Help modal styles */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .shortcuts-section h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 2px 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .shortcut-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-relative {
            position: relative;
        }

        /* Help content styles */
        .help-content {
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .help-content h3 {
            color: var(--accent);
            margin: 20px 0 10px 0;
            font-size: 1rem;
        }

        .help-content h3:first-child {
            margin-top: 0;
        }

        .help-content p {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .help-content ul, .help-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .help-content li {
            margin-bottom: 6px;
        }

        .help-content strong {
            color: var(--text-primary);
        }

        .help-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .help-content .tip {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
        }

        .help-content .label-example {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 6px;
            margin: 2px;
        }

        .help-content .label-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .help-content .nli-label {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
        }

        .help-content .nli-label.entailment { background: #22c55e33; color: #4ade80; }
        .help-content .nli-label.neutral { background: #eab30833; color: #fbbf24; }
        .help-content .nli-label.contradiction { background: #ef444433; color: #f87171; }

        .help-content .api-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            margin: 5px 5px 5px 0;
            transition: background 0.2s;
        }

        .help-content .api-link:hover {
            background: rgba(74, 158, 255, 0.25);
        }

        .help-tab-content {
            display: none;
        }

        .help-tab-content.active {
            display: block;
        }

        /* Leaderboard styles */
        .leaderboard-section {
            margin-top: 30px;
        }

        .leaderboard-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .leaderboard-table th:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .leaderboard-table th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.7rem;
        }

        .leaderboard-table th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 0.7rem;
        }

        .leaderboard-table tbody tr {
            transition: background 0.2s;
        }

        .leaderboard-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-table tbody tr.current-user {
            background: rgba(74, 222, 128, 0.15);
            border-left: 3px solid var(--success);
        }

        .leaderboard-table tbody tr.current-user:hover {
            background: rgba(74, 222, 128, 0.2);
        }

        .rank-cell {
            font-weight: 600;
            color: var(--text-secondary);
            width: 60px;
        }

        .rank-cell.rank-1 { color: #ffd700; }
        .rank-cell.rank-2 { color: #c0c0c0; }
        .rank-cell.rank-3 { color: #cd7f32; }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-cell .display-name {
            font-weight: 500;
        }

        .user-cell .username {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .role-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.admin {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .score-cell {
            font-weight: 600;
            color: var(--accent);
        }

        .reliability-cell {
            color: var(--text-secondary);
            font-style: italic;
        }

        .reliability-cell.reliability-high {
            color: var(--success);
            font-style: normal;
            font-weight: 600;
        }

        .reliability-cell.reliability-medium {
            color: #f59e0b;
            font-style: normal;
            font-weight: 500;
        }

        .reliability-cell.reliability-low {
            color: var(--error);
            font-style: normal;
            font-weight: 500;
        }

        /* Personal stats card */
        .personal-stats-card {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(74, 222, 128, 0.1));
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .personal-stats-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .personal-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .personal-stat-item {
            text-align: center;
        }

        .personal-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .personal-stat-value.rank {
            color: var(--success);
        }

        .personal-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .personal-stat-sublabel {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Admin Dashboard Styles */
        .admin-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .admin-stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .admin-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .admin-stat-sublabel {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .admin-table tbody tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            width: 100px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .activity-bar {
            background: var(--accent-color);
            min-width: 4px;
            border-radius: 2px 2px 0 0;
            transition: height 0.3s ease;
            position: relative;
        }

        .activity-bar:hover {
            opacity: 0.8;
        }

        .activity-bar-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            padding: 2px 4px;
            background: var(--card-bg);
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .activity-bar:hover .activity-bar-label {
            opacity: 1;
        }

        .quality-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .quality-stat:last-child {
            border-bottom: none;
        }

        .quality-stat-label {
            color: var(--text-secondary);
        }

        .quality-stat-value {
            font-weight: 600;
        }

        .reliability-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .reliability-high {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .reliability-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .reliability-low {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .calibrating-badge {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .hotspot-row {
            cursor: pointer;
        }

        .hotspot-row:hover {
            background: rgba(248, 113, 113, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2>NLI Span Labeler</h2>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="modal-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required minlength="6" autocomplete="current-password">
                </div>
                <div id="login-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="register-display">Display Name (optional)</label>
                    <input type="text" id="register-display" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required minlength="6" autocomplete="new-password">
                </div>
                <div id="register-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-success">Create Account</button>
                </div>
            </form>

            <div id="anonymous-note" class="anonymous-note hidden">
                Running in anonymous mode. No login required.
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal modal-wide modal-tall modal-relative">
            <button class="modal-close" onclick="hideHelpModal()">&times;</button>
            <h2>üìñ Help & Documentation</h2>
            
            <div class="modal-tabs" id="help-tabs">
                <button class="modal-tab active" onclick="switchHelpTab('overview')">Overview</button>
                <button class="modal-tab" onclick="switchHelpTab('labels')">Labels</button>
                <button class="modal-tab" onclick="switchHelpTab('shortcuts')">Shortcuts</button>
                <button class="modal-tab" onclick="switchHelpTab('api')">API</button>
            </div>

            <!-- Overview Tab -->
            <div id="help-overview" class="help-tab-content active">
                <div class="help-content">
                    <h3>What is NLI?</h3>
                    <p>
                        <strong>Natural Language Inference (NLI)</strong> is a task where you determine the logical relationship 
                        between two sentences: a <strong>premise</strong> and a <strong>hypothesis</strong>.
                    </p>
                    <p>The three possible relationships are:</p>
                    <ul>
                        <li><span class="nli-label entailment">Entailment</span> - The hypothesis is definitely true given the premise</li>
                        <li><span class="nli-label neutral">Neutral</span> - The hypothesis might be true, but we can't tell from the premise</li>
                        <li><span class="nli-label contradiction">Contradiction</span> - The hypothesis is definitely false given the premise</li>
                    </ul>

                    <h3>Your Task</h3>
                    <p>
                        As an annotator, you'll do two things for each example:
                    </p>
                    <ol>
                        <li><strong>Mark relevant spans</strong> - Click on tokens (words) that are important for understanding the NLI relationship</li>
                        <li><strong>Rate complexity</strong> - Score how difficult the example is across six dimensions</li>
                    </ol>

                    <h3>Annotation Workflow</h3>
                    <ol>
                        <li><strong>Read the example</strong> - Understand the premise and hypothesis</li>
                        <li><strong>Select a label</strong> - Click a label or press <code>1-9</code> to choose what you're marking</li>
                        <li><strong>Mark tokens</strong> - Click tokens or use <code>j/k</code> + <code>Space</code> to select them</li>
                        <li><strong>Adjust complexity scores</strong> - Use the sliders to rate difficulty</li>
                        <li><strong>Save</strong> - Press <code>Enter</code> or click "Save & Next"</li>
                    </ol>

                    <div class="tip">
                        <strong>Tip:</strong> You can mark the same token with multiple labels! Colored dots below each token 
                        show all labels applied to it.
                    </div>

                    <h3>Tokenization</h3>
                    <p>
                        Text is split using <strong>WordPiece tokenization</strong> (the same as ModernBERT). 
                        Sometimes words are split into subword tokens, shown connected with a small dash.
                        For example, "running" might become "run" + "##ning".
                    </p>
                </div>
            </div>

            <!-- Labels Tab -->
            <div id="help-labels" class="help-tab-content">
                <div class="help-content">
                    <h3>Difficulty Dimension Labels</h3>
                    <p>Use these labels to mark tokens that contribute to different types of difficulty:</p>
                    
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #3b82f6;"></span> reasoning</span>
                        Tokens requiring logical inference, deduction, or multi-step reasoning to understand.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #8b5cf6;"></span> creativity</span>
                        Tokens requiring imaginative or non-literal interpretation (metaphors, analogies, figurative language).
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #06b6d4;"></span> domain_knowledge</span>
                        Tokens requiring specialized knowledge (scientific, technical, cultural, etc.).
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #22c55e;"></span> contextual</span>
                        Tokens that depend on implicit context not explicitly stated in the text.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #eab308;"></span> constraints</span>
                        Tokens representing conditions, limitations, or requirements that must be tracked.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #f97316;"></span> ambiguity</span>
                        Tokens that are ambiguous or could be interpreted multiple ways.
                    </p>

                    <h3>NLI Relationship Labels</h3>
                    <p>Use these labels to mark tokens that are key evidence for the NLI relationship:</p>
                    
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #4ade80;"></span> entailment</span>
                        Tokens that support or prove the hypothesis follows from the premise.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #fbbf24;"></span> neutral</span>
                        Tokens that introduce information not determinable from the premise.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #f87171;"></span> contradiction</span>
                        Tokens that conflict or are inconsistent between premise and hypothesis.
                    </p>

                    <h3>Custom Labels</h3>
                    <p>
                        Click <strong>"+ New Label"</strong> to create custom labels for patterns you want to track.
                        You can rename any label by clicking on its name.
                    </p>

                    <h3>Complexity Scores</h3>
                    <p>
                        Rate each example on a scale of <strong>1-100</strong> for six dimensions:
                    </p>
                    <ul>
                        <li><strong>Reasoning</strong> - How much logical inference is required?</li>
                        <li><strong>Creativity</strong> - How much imaginative interpretation is needed?</li>
                        <li><strong>Domain Knowledge</strong> - How much specialized knowledge is required?</li>
                        <li><strong>Contextual</strong> - How much does it depend on implicit context?</li>
                        <li><strong>Constraints</strong> - How many conditions must be tracked?</li>
                        <li><strong>Ambiguity</strong> - How debatable is the answer?</li>
                    </ul>

                    <div class="tip">
                        <strong>Tip:</strong> Don't overthink the scores! Quick intuitive ratings are fine. 
                        The goal is relative difficulty, not precise measurement.
                    </div>
                </div>
            </div>

            <!-- Shortcuts Tab -->
            <div id="help-shortcuts" class="help-tab-content">
                <div class="help-content">
                    <div class="shortcuts-grid">
                        <div class="shortcuts-section">
                            <h4>Navigation</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">j</span> <span class="shortcut-key">‚Üí</span></span>
                                <span class="shortcut-desc">Next word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">k</span> <span class="shortcut-key">‚Üê</span></span>
                                <span class="shortcut-desc">Previous word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Tab</span></span>
                                <span class="shortcut-desc">Switch premise/hypothesis</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Home</span></span>
                                <span class="shortcut-desc">First word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">End</span></span>
                                <span class="shortcut-desc">Last word</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Labeling</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">1</span>-<span class="shortcut-key">9</span></span>
                                <span class="shortcut-desc">Toggle label on focused word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Space</span></span>
                                <span class="shortcut-desc">Toggle active label on word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">c</span></span>
                                <span class="shortcut-desc">Clear all selections</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Actions</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Enter</span></span>
                                <span class="shortcut-desc">Save & next example</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Esc</span></span>
                                <span class="shortcut-desc">Skip example</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">n</span></span>
                                <span class="shortcut-desc">Load next example</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Help</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">?</span></span>
                                <span class="shortcut-desc">Toggle this help</span>
                            </div>
                        </div>
                    </div>

                    <div class="tip" style="margin-top: 20px;">
                        <strong>Power User Workflow:</strong> Press <code>1</code> to select "reasoning", 
                        use <code>j/k</code> to navigate, <code>Space</code> to mark, then <code>Enter</code> to save.
                        You can annotate without touching the mouse!
                    </div>
                </div>
            </div>

            <!-- API Tab -->
            <div id="help-api" class="help-tab-content">
                <div class="help-content">
                    <h3>API Documentation</h3>
                    <p>
                        For programmatic access to the annotation data, the API is fully documented with interactive endpoints:
                    </p>
                    
                    <p>
                        <a href="/docs" target="_blank" class="api-link">üìò Swagger UI (/docs)</a>
                        <a href="/redoc" target="_blank" class="api-link">üìï ReDoc (/redoc)</a>
                    </p>

                    <h3>Key Endpoints</h3>
                    <ul>
                        <li><code>GET /api/next</code> - Get the next unlabeled example</li>
                        <li><code>GET /api/example/{dataset}/{id}</code> - Get a specific example</li>
                        <li><code>POST /api/annotate</code> - Submit annotations</li>
                        <li><code>GET /api/stats</code> - Get annotation statistics</li>
                        <li><code>GET /api/export</code> - Export all annotations as JSONL</li>
                    </ul>

                    <h3>Authentication</h3>
                    <p>
                        The API uses session-based authentication via cookies. Log in through the web interface 
                        or use the <code>/api/auth/login</code> endpoint.
                    </p>
                    <p>
                        If the server is running with <code>ANONYMOUS_MODE=1</code>, no authentication is required.
                    </p>

                    <h3>Export Format</h3>
                    <p>
                        Exported data is in JSONL format with each line containing:
                    </p>
                    <ul>
                        <li>Example ID, dataset, premise, hypothesis, gold label</li>
                        <li>Annotator information</li>
                        <li>Complexity scores for all six dimensions</li>
                        <li>Span labels with token indices and character offsets</li>
                        <li>Tokenizer model used</li>
                    </ul>
                </div>
            </div>

            <p style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                Press <span class="shortcut-key">?</span> or <span class="shortcut-key">Esc</span> to close
            </p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>NLI Span Labeler</h1>
            <div class="header-buttons">
                <span class="tokenizer-badge" id="tokenizer-badge">Loading...</span>
                <span id="user-info" class="user-badge hidden">
                    <span class="username" id="username-display"></span>
                    <button class="logout-btn" onclick="handleLogout()" title="Logout">‚úï</button>
                </span>
                <button class="help-btn" onclick="showHelpModal()" title="Help & documentation (?)">?</button>
                <button class="btn btn-secondary" onclick="showStats()">Stats</button>
                <button class="btn btn-secondary" onclick="exportLabels()">Export</button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="labeler" onclick="switchTab('labeler')">Labeler</button>
            <button class="nav-tab" data-tab="stats" onclick="switchTab('stats')">Statistics</button>
            <button class="nav-tab" data-tab="lookup" onclick="switchTab('lookup')">Lookup</button>
            <button class="nav-tab hidden" data-tab="admin" id="admin-tab-btn" onclick="switchTab('admin')">üìä Admin Dashboard</button>
        </div>

        <!-- Labeler Tab -->
        <div id="labeler-tab" class="tab-content">
            <div class="dataset-selector">
                <label>Dataset:</label>
                <select id="dataset-select" onchange="loadNextExample()">
                    <option value="">Any</option>
                </select>
                <button class="btn btn-primary" onclick="loadNextExample()">Next Example</button>
            </div>

            <div class="instructions">
                <strong>Instructions:</strong>
                1. Click a label below to select it (or press <strong>1-9</strong>).
                2. Click tokens or use <strong>j/k</strong> to navigate and <strong>Space</strong> to toggle.
                3. <em>Connected tokens</em> (with a dash) are WordPiece subwords.
                4. Press <strong>Enter</strong> to save, <strong>Esc</strong> to skip, <strong>?</strong> for all shortcuts.
            </div>

            <div id="message-area"></div>

            <div id="example-area" class="card">
                <div class="loading">Loading example...</div>
            </div>

            <!-- Span Labels Section -->
            <div class="card labels-section">
                <div class="labels-header">
                    <h3>Span Labels</h3>
                    <button class="btn btn-secondary" onclick="addNewLabel()">+ New Label</button>
                </div>
                <div class="labels-grid" id="labels-grid"></div>
                <div class="legend" id="legend"></div>
            </div>

            <!-- Complexity Scores Section -->
            <div class="card complexity-section">
                <h3 style="margin-bottom: 15px;">Complexity Scores (1-100)</h3>
                <div class="complexity-grid" id="complexity-grid"></div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-warning" onclick="skipExample()">Skip <span style="opacity: 0.6; font-size: 0.8em;">(Esc)</span></button>
                <div>
                    <button class="btn btn-secondary" onclick="clearSelections()">Clear All <span style="opacity: 0.6; font-size: 0.8em;">(c)</span></button>
                    <button class="btn btn-success" onclick="saveAndNext()">Save & Next <span style="opacity: 0.6; font-size: 0.8em;">(Enter)</span></button>
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content hidden">
            <!-- Personal Stats Card -->
            <div id="personal-stats-card" class="personal-stats-card hidden">
                <h3>üèÜ Your Progress</h3>
                <div class="personal-stats-grid" id="personal-stats-grid">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Labeling Statistics</h3>
                <div id="stats-content" class="stats-grid">
                    <div class="loading">Loading stats...</div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="card leaderboard-section">
                <h3>üèÖ Annotator Leaderboard</h3>
                <div id="leaderboard-content">
                    <div class="loading">Loading leaderboard...</div>
                </div>
            </div>
        </div>

        <!-- Lookup Tab -->
        <div id="lookup-tab" class="tab-content hidden">
            <div class="card">
                <h3 style="margin-bottom: 15px;">Lookup Example</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="lookup-dataset" placeholder="Dataset (e.g., snli)"
                           style="flex: 1; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                    <input type="text" id="lookup-id" placeholder="Example ID"
                           style="flex: 2; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                    <button class="btn btn-primary" onclick="lookupExample()">Lookup</button>
                </div>
                <div id="lookup-result"></div>
            </div>
        </div>

        <!-- Admin Dashboard Tab (Admin Only) -->
        <div id="admin-tab" class="tab-content hidden">
            <div class="admin-dashboard">
                <!-- Dashboard Header with Filters -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0;">üìä Admin Dashboard</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="admin-dataset-filter" onchange="loadAdminDashboard()" style="padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                                <option value="">All Datasets</option>
                            </select>
                            <select id="admin-days-filter" onchange="loadAdminDashboard()" style="padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadAdminDashboard()">üîÑ Refresh</button>
                        </div>
                    </div>
                </div>

                <!-- Overview Cards -->
                <div id="admin-overview" class="admin-overview-grid">
                    <div class="loading">Loading dashboard...</div>
                </div>

                <!-- Activity Chart -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üìà Annotation Activity</h3>
                    <div id="admin-activity-chart" style="height: 200px; display: flex; align-items: flex-end; gap: 2px; padding: 10px 0;">
                        <div class="loading">Loading activity...</div>
                    </div>
                </div>

                <!-- Two-column layout for tables -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Dataset Breakdown -->
                    <div class="card">
                        <h3>üìÅ Dataset Progress</h3>
                        <div id="admin-datasets-table">
                            <div class="loading">Loading datasets...</div>
                        </div>
                    </div>

                    <!-- Quality Indicators -->
                    <div class="card">
                        <h3>‚ö†Ô∏è Quality Indicators</h3>
                        <div id="admin-quality-indicators">
                            <div class="loading">Loading quality data...</div>
                        </div>
                    </div>
                </div>

                <!-- Annotator Table -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üë• Annotator Breakdown</h3>
                    <div id="admin-annotators-table" style="overflow-x: auto;">
                        <div class="loading">Loading annotators...</div>
                    </div>
                </div>

                <!-- Disagreement Hotspots -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üî• Disagreement Hotspots</h3>
                    <p style="color: #888; font-size: 0.9em;">Examples with low agreement scores that may need review</p>
                    <div id="admin-hotspots-table">
                        <div class="loading">Loading hotspots...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================
        let currentExample = null;
        let activeLabel = null;
        let labels = [];
        let currentUser = null;
        let isAnonymousMode = false;

        // Leaderboard state
        let leaderboardData = [];
        let leaderboardSortColumn = 'labeled';
        let leaderboardSortDirection = 'desc';

        // Keyboard navigation state
        let focusedSource = 'premise';  // 'premise' or 'hypothesis'
        let focusedWordIndex = -1;       // -1 means no focus

        // Pre-defined labels with colors
        const presetLabels = [
            // Difficulty dimensions
            { name: 'reasoning', color: '#3b82f6', colorIndex: 0 },
            { name: 'creativity', color: '#8b5cf6', colorIndex: 1 },
            { name: 'domain_knowledge', color: '#06b6d4', colorIndex: 2 },
            { name: 'contextual', color: '#22c55e', colorIndex: 3 },
            { name: 'constraints', color: '#eab308', colorIndex: 4 },
            { name: 'ambiguity', color: '#f97316', colorIndex: 5 },
            // NLI labels
            { name: 'entailment', color: '#4ade80', colorIndex: 6 },
            { name: 'neutral', color: '#fbbf24', colorIndex: 7 },
            { name: 'contradiction', color: '#f87171', colorIndex: 8 },
        ];

        // Complexity dimensions
        const complexityDimensions = [
            { key: 'reasoning', label: 'Reasoning', description: 'Logical inference required' },
            { key: 'creativity', label: 'Creativity', description: 'Imaginative interpretation' },
            { key: 'domain_knowledge', label: 'Domain Knowledge', description: 'Specialized expertise' },
            { key: 'contextual', label: 'Contextual', description: 'Implicit context dependence' },
            { key: 'constraints', label: 'Constraints', description: 'Conditions to track' },
            { key: 'ambiguity', label: 'Ambiguity', description: 'Answer debatability' },
        ];

        // ============================================================================
        // Authentication
        // ============================================================================

        async function checkAuthStatus() {
            try {
                // First check if we're in anonymous mode
                const statusResp = await fetch('/api/auth/status');
                const status = await statusResp.json();
                isAnonymousMode = status.anonymous_mode;

                if (isAnonymousMode) {
                    // Anonymous mode - no login needed
                    currentUser = { username: 'anonymous', display_name: 'Anonymous', is_anonymous: true };
                    hideAuthModal();
                    updateUserDisplay();
                    return true;
                }

                // Check if user is already logged in
                const meResp = await fetch('/api/me');
                const meData = await meResp.json();

                if (meData.authenticated === false) {
                    // Not logged in - show auth modal
                    showAuthModal();
                    return false;
                }

                // User is logged in
                currentUser = meData;
                hideAuthModal();
                updateUserDisplay();
                return true;
            } catch (e) {
                console.error('Auth check failed:', e);
                showAuthModal();
                return false;
            }
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            if (isAnonymousMode) {
                document.getElementById('anonymous-note').classList.remove('hidden');
            }
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('#auth-modal .modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#auth-modal .modal-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
            
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
            
            // Clear errors
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    errorEl.textContent = err.detail || 'Login failed';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success - reload auth state
                await checkAuthStatus();
                initializeApp();
            } catch (e) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('register-username').value;
            const display_name = document.getElementById('register-display').value || null;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');

            try {
                const resp = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, display_name })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    errorEl.textContent = err.detail || 'Registration failed';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success - reload auth state
                await checkAuthStatus();
                initializeApp();
            } catch (e) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                showAuthModal();
                updateUserDisplay();
            } catch (e) {
                console.error('Logout failed:', e);
            }
        }

        function updateUserDisplay() {
            const userInfo = document.getElementById('user-info');
            const usernameDisplay = document.getElementById('username-display');

            if (currentUser) {
                usernameDisplay.textContent = currentUser.display_name || currentUser.username;
                userInfo.classList.remove('hidden');
                
                // Hide logout button in anonymous mode
                const logoutBtn = userInfo.querySelector('.logout-btn');
                if (currentUser.is_anonymous) {
                    logoutBtn.classList.add('hidden');
                } else {
                    logoutBtn.classList.remove('hidden');
                }
            } else {
                userInfo.classList.add('hidden');
            }
        }

        // ============================================================================
        // Authenticated Fetch (handles 401s)
        // ============================================================================

        async function authenticatedFetch(url, options = {}) {
            const resp = await fetch(url, options);
            
            if (resp.status === 401) {
                // Session expired or not authenticated
                currentUser = null;
                showAuthModal();
                updateUserDisplay();
                throw new Error('Session expired. Please log in again.');
            }
            
            return resp;
        }

        // ============================================================================
        // Help Modal
        // ============================================================================

        function showHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function hideHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        function toggleHelpModal() {
            const modal = document.getElementById('help-modal');
            if (modal.classList.contains('hidden')) {
                showHelpModal();
            } else {
                hideHelpModal();
            }
        }

        function switchHelpTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#help-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.help-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`help-${tabName}`).classList.add('active');
        }

        // ============================================================================
        // Keyboard Navigation
        // ============================================================================

        function initKeyboardNavigation() {
            document.addEventListener('keydown', handleKeyDown);
        }

        function handleKeyDown(e) {
            // Don't handle keys when typing in inputs
            if (e.target.matches('input, textarea, select')) {
                return;
            }

            // Don't handle if auth modal is shown
            if (!document.getElementById('auth-modal').classList.contains('hidden')) {
                return;
            }

            // Help modal toggle (? key)
            if (e.key === '?') {
                e.preventDefault();
                toggleHelpModal();
                return;
            }

            // Close help modal with Escape
            if (e.key === 'Escape') {
                if (!document.getElementById('help-modal').classList.contains('hidden')) {
                    e.preventDefault();
                    hideHelpModal();
                    return;
                }
            }

            // Only process labeler shortcuts when on labeler tab
            if (document.getElementById('labeler-tab').classList.contains('hidden')) {
                return;
            }

            // Help modal is open - don't process other shortcuts
            if (!document.getElementById('help-modal').classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    hideHelpModal();
                }
                return;
            }

            switch (e.key) {
                // Navigation: j/k or arrows
                case 'j':
                case 'ArrowRight':
                    e.preventDefault();
                    navigateWord(1);
                    break;
                case 'k':
                case 'ArrowLeft':
                    e.preventDefault();
                    navigateWord(-1);
                    break;

                // Tab: switch premise/hypothesis
                case 'Tab':
                    e.preventDefault();
                    switchFocusSource();
                    break;

                // Home/End: first/last word
                case 'Home':
                    e.preventDefault();
                    focusFirstWord();
                    break;
                case 'End':
                    e.preventDefault();
                    focusLastWord();
                    break;

                // Space: toggle active label on focused word
                case ' ':
                    e.preventDefault();
                    toggleLabelOnFocusedWord();
                    break;

                // Number keys 1-9: toggle specific label
                case '1': case '2': case '3': case '4': case '5':
                case '6': case '7': case '8': case '9':
                    e.preventDefault();
                    toggleLabelByNumber(parseInt(e.key) - 1);
                    break;

                // Enter: save and next
                case 'Enter':
                    e.preventDefault();
                    saveAndNext();
                    break;

                // Escape: skip
                case 'Escape':
                    e.preventDefault();
                    skipExample();
                    break;

                // n: load next example
                case 'n':
                    e.preventDefault();
                    loadNextExample();
                    break;

                // c: clear all selections
                case 'c':
                    e.preventDefault();
                    clearSelections();
                    break;
            }
        }

        function getWordCount(source) {
            if (!currentExample) return 0;
            return source === 'premise' 
                ? currentExample.premise_words.length 
                : currentExample.hypothesis_words.length;
        }

        function navigateWord(delta) {
            if (!currentExample) return;

            const wordCount = getWordCount(focusedSource);
            if (wordCount === 0) return;

            if (focusedWordIndex === -1) {
                // No current focus - start at beginning or end
                focusedWordIndex = delta > 0 ? 0 : wordCount - 1;
            } else {
                focusedWordIndex += delta;
                // Wrap around
                if (focusedWordIndex < 0) focusedWordIndex = wordCount - 1;
                if (focusedWordIndex >= wordCount) focusedWordIndex = 0;
            }

            updateFocusDisplay();
        }

        function switchFocusSource() {
            focusedSource = focusedSource === 'premise' ? 'hypothesis' : 'premise';
            
            // Clamp index to new source's word count
            const wordCount = getWordCount(focusedSource);
            if (focusedWordIndex >= wordCount) {
                focusedWordIndex = wordCount - 1;
            }
            if (focusedWordIndex < 0 && wordCount > 0) {
                focusedWordIndex = 0;
            }

            updateFocusDisplay();
        }

        function focusFirstWord() {
            if (!currentExample) return;
            focusedWordIndex = 0;
            updateFocusDisplay();
        }

        function focusLastWord() {
            if (!currentExample) return;
            const wordCount = getWordCount(focusedSource);
            focusedWordIndex = wordCount - 1;
            updateFocusDisplay();
        }

        function toggleLabelOnFocusedWord() {
            if (focusedWordIndex === -1 || activeLabel === null) {
                if (activeLabel === null) {
                    showMessage('Select a label first (1-9 keys)', 'error');
                }
                return;
            }
            toggleWord(focusedSource, focusedWordIndex);
        }

        function toggleLabelByNumber(labelIndex) {
            if (labelIndex >= labels.length) return;

            // Select this label as active
            activeLabel = labelIndex;
            renderLabels();

            // If we have a focused word, toggle it immediately
            if (focusedWordIndex !== -1) {
                toggleWord(focusedSource, focusedWordIndex);
            }

            updateWordHighlights();
        }

        function updateFocusDisplay() {
            // Remove old focus
            document.querySelectorAll('.word.keyboard-focus').forEach(el => {
                el.classList.remove('keyboard-focus');
            });
            document.querySelectorAll('.text-section.active-section').forEach(el => {
                el.classList.remove('active-section');
            });

            if (focusedWordIndex === -1 || !currentExample) return;

            // Add focus to current word
            const wordEl = document.querySelector(
                `.word[data-source="${focusedSource}"][data-index="${focusedWordIndex}"]`
            );
            if (wordEl) {
                wordEl.classList.add('keyboard-focus');
                // Scroll into view if needed
                wordEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Highlight the active section
            const sectionEl = document.getElementById(`${focusedSource}-text`)?.closest('.text-section');
            if (sectionEl) {
                sectionEl.classList.add('active-section');
            }
        }

        function resetFocus() {
            focusedWordIndex = -1;
            focusedSource = 'premise';
            updateFocusDisplay();
        }

        // ============================================================================
        // Initialization
        // ============================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth first
            const isAuthenticated = await checkAuthStatus();
            
            if (isAuthenticated) {
                initializeApp();
            }

            // Always init keyboard navigation
            initKeyboardNavigation();
        });

        async function initializeApp() {
            await Promise.all([
                loadDatasets(),
                loadTokenizerInfo()
            ]);
            initLabels();
            initComplexityInputs();
            loadNextExample();
        }

        async function loadTokenizerInfo() {
            try {
                const resp = await fetch('/api/tokenizer/info');
                const info = await resp.json();
                const badge = document.getElementById('tokenizer-badge');
                // Show just the model name, not the full path
                const shortName = info.model.split('/').pop();
                badge.textContent = shortName;
                badge.title = `Tokenizer: ${info.model} (${info.type}, vocab: ${info.vocab_size.toLocaleString()})`;
            } catch (e) {
                console.error('Failed to load tokenizer info:', e);
                document.getElementById('tokenizer-badge').textContent = 'tokenizer';
            }
        }

        async function loadDatasets() {
            try {
                const resp = await fetch('/api/datasets');
                const data = await resp.json();
                const select = document.getElementById('dataset-select');
                data.datasets.forEach(ds => {
                    const option = document.createElement('option');
                    option.value = ds;
                    option.textContent = ds;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load datasets:', e);
            }
        }

        function initLabels() {
            labels = presetLabels.map(p => ({
                ...p,
                spans: { premise: new Set(), hypothesis: new Set() }
            }));
            renderLabels();
            renderLegend();
        }

        function initComplexityInputs() {
            const grid = document.getElementById('complexity-grid');
            grid.innerHTML = complexityDimensions.map(dim => `
                <div class="complexity-item">
                    <div class="complexity-label">${dim.label}</div>
                    <div class="complexity-input">
                        <input type="range" id="complexity-range-${dim.key}"
                               min="1" max="100" value="50"
                               oninput="syncComplexity('${dim.key}', this.value, 'range')">
                        <input type="number" id="complexity-num-${dim.key}"
                               min="1" max="100" value="50"
                               oninput="syncComplexity('${dim.key}', this.value, 'num')">
                    </div>
                </div>
            `).join('');
        }

        function syncComplexity(key, value, source) {
            // Clamp value to valid range
            value = Math.max(1, Math.min(100, parseInt(value) || 50));

            const rangeInput = document.getElementById(`complexity-range-${key}`);
            const numInput = document.getElementById(`complexity-num-${key}`);

            if (source === 'range') {
                numInput.value = value;
            } else {
                rangeInput.value = value;
            }
        }

        // ============================================================================
        // Labels
        // ============================================================================

        function renderLabels() {
            const grid = document.getElementById('labels-grid');
            grid.innerHTML = labels.map((label, idx) => {
                const totalSpans = label.spans.premise.size + label.spans.hypothesis.size;
                const isActive = activeLabel === idx;
                const keyHint = idx < 9 ? idx + 1 : '';
                return `
                    <div class="label-item ${isActive ? 'active' : ''}"
                         onclick="selectLabel(${idx})"
                         data-label-idx="${idx}">
                        <div class="label-color" style="background: ${label.color}"></div>
                        <div class="label-name">
                            <input type="text" value="${label.name}"
                                   onclick="event.stopPropagation()"
                                   onchange="updateLabelName(${idx}, this.value)">
                        </div>
                        ${keyHint ? `<span class="label-key">${keyHint}</span>` : ''}
                        ${totalSpans > 0 ? `<span class="label-count">${totalSpans}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = labels.map(l => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: ${l.color}"></div>
                    <span>${l.name}</span>
                </div>
            `).join('');
        }

        function selectLabel(idx) {
            activeLabel = activeLabel === idx ? null : idx;
            renderLabels();
            updateWordHighlights();
        }

        function updateLabelName(idx, newName) {
            labels[idx].name = newName;
            renderLegend();
        }

        function addNewLabel() {
            const colorIndex = labels.length % 9;
            const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#22c55e', '#eab308', '#f97316', '#4ade80', '#fbbf24', '#f87171'];
            labels.push({
                name: `custom_${labels.length + 1}`,
                color: colors[colorIndex],
                colorIndex: colorIndex,
                spans: { premise: new Set(), hypothesis: new Set() }
            });
            renderLabels();
            renderLegend();
        }

        // ============================================================================
        // Examples
        // ============================================================================

        async function loadNextExample() {
            const dataset = document.getElementById('dataset-select').value;
            const area = document.getElementById('example-area');
            area.innerHTML = '<div class="loading">Loading example...</div>';

            try {
                const url = dataset ? `/api/next?dataset=${dataset}` : '/api/next';
                const resp = await authenticatedFetch(url);
                const data = await resp.json();

                if (data.complete) {
                    area.innerHTML = `<div class="message success">${data.message}</div>`;
                    currentExample = null;
                    return;
                }

                currentExample = data;
                resetLabelsForNewExample();
                renderExample();
                resetFocus();
            } catch (e) {
                area.innerHTML = `<div class="message error">Error loading example: ${e.message}</div>`;
            }
        }

        function resetLabelsForNewExample() {
            labels.forEach(label => {
                label.spans = { premise: new Set(), hypothesis: new Set() };
            });
            activeLabel = null;
            renderLabels();

            // Reset complexity scores to 50
            complexityDimensions.forEach(dim => {
                const rangeInput = document.getElementById(`complexity-range-${dim.key}`);
                const numInput = document.getElementById(`complexity-num-${dim.key}`);
                if (rangeInput) rangeInput.value = 50;
                if (numInput) numInput.value = 50;
            });
        }

        function renderExample() {
            if (!currentExample) return;

            const area = document.getElementById('example-area');
            const goldLabelClass = currentExample.gold_label_text || 'neutral';

            area.innerHTML = `
                <div class="example-header">
                    <span class="example-id">${currentExample.id}</span>
                    <span class="gold-label ${goldLabelClass}">${currentExample.gold_label_text || 'unknown'}</span>
                </div>
                <div class="text-section" id="premise-section">
                    <div class="text-label">Premise</div>
                    <div class="text-content" id="premise-text">
                        ${renderWords(currentExample.premise_words, 'premise')}
                    </div>
                </div>
                <div class="text-section" id="hypothesis-section">
                    <div class="text-label">Hypothesis</div>
                    <div class="text-content" id="hypothesis-text">
                        ${renderWords(currentExample.hypothesis_words, 'hypothesis')}
                    </div>
                </div>
            `;

            // Load existing labels if any
            if (currentExample.existing_labels && currentExample.existing_labels.length > 0) {
                loadExistingLabels(currentExample.existing_labels);
            }

            // Load existing scores if any
            if (currentExample.existing_scores) {
                Object.entries(currentExample.existing_scores).forEach(([key, value]) => {
                    if (value !== null) {
                        const rangeInput = document.getElementById(`complexity-range-${key}`);
                        const numInput = document.getElementById(`complexity-num-${key}`);
                        if (rangeInput) rangeInput.value = value;
                        if (numInput) numInput.value = value;
                    }
                });
            }
        }

        function renderWords(words, source) {
            return words.map(w => {
                const isSubword = w.is_subword || false;
                const containerClass = isSubword ? 'word-container subword' : 'word-container';
                const wordClass = isSubword ? 'word subword' : 'word';
                const title = w.token ? `Token: ${w.token}` : '';
                
                return `
                    <span class="${containerClass}">
                        <span class="${wordClass}"
                              data-source="${source}"
                              data-index="${w.index}"
                              data-char-start="${w.char_start}"
                              data-char-end="${w.char_end}"
                              data-is-subword="${isSubword}"
                              title="${title}"
                              onclick="handleWordClick('${source}', ${w.index})">${w.text}</span>
                        <div class="label-dots" data-source="${source}" data-index="${w.index}"></div>
                    </span>
                `;
            }).join('');
        }

        function handleWordClick(source, index) {
            // Update keyboard focus to clicked word
            focusedSource = source;
            focusedWordIndex = index;
            updateFocusDisplay();

            // Toggle label
            toggleWord(source, index);
        }

        function loadExistingLabels(existingLabels) {
            existingLabels.forEach(existing => {
                let labelIdx = labels.findIndex(l => l.name === existing.label_name);
                if (labelIdx === -1) {
                    const colorIndex = labels.length % 9;
                    const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#22c55e', '#eab308', '#f97316', '#4ade80', '#fbbf24', '#f87171'];
                    labels.push({
                        name: existing.label_name,
                        color: existing.label_color || colors[colorIndex],
                        colorIndex: colorIndex,
                        spans: { premise: new Set(), hypothesis: new Set() }
                    });
                    labelIdx = labels.length - 1;
                }

                existing.spans.forEach(span => {
                    labels[labelIdx].spans[span.source].add(span.word_index);
                });
            });

            renderLabels();
            renderLegend();
            updateWordHighlights();
        }

        function toggleWord(source, index) {
            if (activeLabel === null) {
                showMessage('Select a label first (click or press 1-9)', 'error');
                return;
            }

            const spans = labels[activeLabel].spans[source];
            if (spans.has(index)) {
                spans.delete(index);
            } else {
                spans.add(index);
            }

            renderLabels();
            updateWordHighlights();
        }

        function updateWordHighlights() {
            // Clear all word styles and dots
            document.querySelectorAll('.word').forEach(el => {
                // Preserve subword and keyboard-focus classes if present
                const isSubword = el.dataset.isSubword === 'true';
                const hasFocus = el.classList.contains('keyboard-focus');
                el.className = isSubword ? 'word subword' : 'word';
                if (hasFocus) el.classList.add('keyboard-focus');
            });
            document.querySelectorAll('.label-dots').forEach(el => {
                el.innerHTML = '';
            });

            // Build a map of word -> labels for each source
            const wordLabels = { premise: {}, hypothesis: {} };

            labels.forEach((label, labelIdx) => {
                ['premise', 'hypothesis'].forEach(source => {
                    label.spans[source].forEach(wordIdx => {
                        if (!wordLabels[source][wordIdx]) {
                            wordLabels[source][wordIdx] = [];
                        }
                        wordLabels[source][wordIdx].push({
                            labelIdx,
                            color: label.color,
                            colorIndex: label.colorIndex
                        });
                    });
                });
            });

            // Apply highlights and dots
            ['premise', 'hypothesis'].forEach(source => {
                Object.entries(wordLabels[source]).forEach(([wordIdx, labelList]) => {
                    const wordEl = document.querySelector(
                        `.word[data-source="${source}"][data-index="${wordIdx}"]`
                    );
                    const dotsEl = document.querySelector(
                        `.label-dots[data-source="${source}"][data-index="${wordIdx}"]`
                    );

                    if (wordEl && dotsEl) {
                        // Check if active label is in this word's labels
                        const hasActiveLabel = labelList.some(l => l.labelIdx === activeLabel);

                        if (hasActiveLabel && activeLabel !== null) {
                            // Style word with active label's color
                            const activeLabelInfo = labelList.find(l => l.labelIdx === activeLabel);
                            wordEl.classList.add('has-active-label', `color-${activeLabelInfo.colorIndex}`);
                        }

                        // Create dots for all labels, with active label's dot larger
                        // Sort so active label's dot is first (most visible)
                        const sortedLabels = [...labelList].sort((a, b) => {
                            if (a.labelIdx === activeLabel) return -1;
                            if (b.labelIdx === activeLabel) return 1;
                            return 0;
                        });

                        dotsEl.innerHTML = sortedLabels.map(l => `
                            <div class="label-dot ${l.labelIdx === activeLabel ? 'active-label' : ''}"
                                 style="background: ${l.color}; color: ${l.color};"
                                 title="${labels[l.labelIdx].name}"></div>
                        `).join('');
                    }
                });
            });
        }

        function clearSelections() {
            labels.forEach(label => {
                label.spans = { premise: new Set(), hypothesis: new Set() };
            });
            activeLabel = null;
            renderLabels();
            updateWordHighlights();
            showMessage('Cleared all selections', 'success');
        }

        // ============================================================================
        // Save / Skip
        // ============================================================================

        async function saveAndNext() {
            if (!currentExample) return;

            const labelData = labels
                .filter(l => l.spans.premise.size > 0 || l.spans.hypothesis.size > 0)
                .map(l => ({
                    label_name: l.name,
                    label_color: l.color,
                    spans: [
                        ...Array.from(l.spans.premise).map(idx => {
                            const wordData = currentExample.premise_words[idx];
                            return {
                                source: 'premise',
                                word_index: idx,
                                word_text: wordData.text,
                                char_start: wordData.char_start,
                                char_end: wordData.char_end
                            };
                        }),
                        ...Array.from(l.spans.hypothesis).map(idx => {
                            const wordData = currentExample.hypothesis_words[idx];
                            return {
                                source: 'hypothesis',
                                word_index: idx,
                                word_text: wordData.text,
                                char_start: wordData.char_start,
                                char_end: wordData.char_end
                            };
                        })
                    ]
                }));

            const complexityScores = {};
            complexityDimensions.forEach(dim => {
                const numInput = document.getElementById(`complexity-num-${dim.key}`);
                if (numInput) {
                    complexityScores[dim.key] = parseInt(numInput.value) || 50;
                }
            });

            try {
                const resp = await authenticatedFetch('/api/annotate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        example_id: currentExample.id,
                        labels: labelData,
                        complexity_scores: complexityScores
                    })
                });

                if (resp.ok) {
                    showMessage('Saved successfully!', 'success');
                    loadNextExample();
                } else {
                    const err = await resp.json();
                    showMessage(`Error: ${err.detail}`, 'error');
                }
            } catch (e) {
                showMessage(`Error saving: ${e.message}`, 'error');
            }
        }

        async function skipExample() {
            if (!currentExample) return;
            try {
                await authenticatedFetch(`/api/skip/${currentExample.id}`, { method: 'POST' });
                showMessage('Skipped', 'success');
                loadNextExample();
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        // ============================================================================
        // UI Helpers
        // ============================================================================

        function showMessage(text, type) {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => { area.innerHTML = ''; }, 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'stats') loadStats();
        }

        async function loadStats() {
            const content = document.getElementById('stats-content');
            content.innerHTML = '<div class="loading">Loading stats...</div>';

            try {
                const resp = await authenticatedFetch('/api/stats');
                const stats = await resp.json();

                // Render personal stats card
                renderPersonalStats(stats);

                // Render general stats
                let html = `
                    <div class="stat-card">
                        <div class="stat-label">Total Labeled</div>
                        <div class="stat-value">${stats.total_labeled}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Spans</div>
                        <div class="stat-value">${stats.spans.total_spans}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Examples with Spans</div>
                        <div class="stat-value">${stats.spans.examples_with_spans}</div>
                    </div>
                `;

                Object.entries(stats.datasets).forEach(([ds, info]) => {
                    const labeled = stats.labeled[ds] || 0;
                    const skipped = stats.skipped[ds] || 0;
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">${ds}</div>
                            <div class="stat-value">${labeled}/${info.total}</div>
                            <div style="font-size: 0.8rem; color: #aaa;">${skipped} skipped</div>
                        </div>
                    `;
                });

                if (stats.complexity_averages) {
                    html += '<div style="grid-column: 1 / -1; margin-top: 20px;"><h4>Average Complexity Scores</h4></div>';
                    Object.entries(stats.complexity_averages).forEach(([key, val]) => {
                        if (val !== null) {
                            html += `
                                <div class="stat-card">
                                    <div class="stat-label">${key}</div>
                                    <div class="stat-value">${val.toFixed(1)}</div>
                                </div>
                            `;
                        }
                    });
                }

                if (Object.keys(stats.label_distribution).length > 0) {
                    html += '<div style="grid-column: 1 / -1; margin-top: 20px;"><h4>Label Distribution</h4></div>';
                    Object.entries(stats.label_distribution).forEach(([name, data]) => {
                        const count = typeof data === 'object' ? data.count : data;
                        html += `
                            <div class="stat-card">
                                <div class="stat-label">${name}</div>
                                <div class="stat-value">${count}</div>
                            </div>
                        `;
                    });
                }

                content.innerHTML = html;

                // Render leaderboard
                renderLeaderboard(stats.annotators || []);
            } catch (e) {
                content.innerHTML = `<div class="message error">Error loading stats: ${e.message}</div>`;
            }
        }

        function renderPersonalStats(stats) {
            const card = document.getElementById('personal-stats-card');
            const grid = document.getElementById('personal-stats-grid');

            if (!stats.user_stats || !currentUser || currentUser.is_anonymous) {
                card.classList.add('hidden');
                return;
            }

            card.classList.remove('hidden');

            // Calculate user's rank
            const annotators = stats.annotators || [];
            const sortedAnnotators = [...annotators].sort((a, b) => b.labeled - a.labeled);
            const userRank = sortedAnnotators.findIndex(a => a.username === currentUser.username) + 1;
            const totalAnnotators = sortedAnnotators.length;

            grid.innerHTML = `
                <div class="personal-stat-item">
                    <div class="personal-stat-value rank">#${userRank || '‚Äî'}</div>
                    <div class="personal-stat-label">Rank</div>
                    <div class="personal-stat-sublabel">of ${totalAnnotators} annotators</div>
                </div>
                <div class="personal-stat-item">
                    <div class="personal-stat-value">${stats.user_stats.labeled}</div>
                    <div class="personal-stat-label">Annotations</div>
                </div>
                <div class="personal-stat-item">
                    <div class="personal-stat-value">${stats.user_stats.skipped}</div>
                    <div class="personal-stat-label">Skipped</div>
                </div>
            `;

            // Fetch reliability score separately
            try {
                const reliabilityResp = await fetch('/api/reliability/me');
                if (reliabilityResp.ok) {
                    const reliability = await reliabilityResp.json();
                    const reliabilityDisplay = reliability.calibration_status === 'calibrated' && reliability.reliability_score !== null
                        ? Math.round(reliability.reliability_score)
                        : null;
                    const reliabilitySublabel = reliability.calibration_status === 'provisional'
                        ? `${reliability.scored_annotation_count}/${reliability.calibration_threshold} calibrating`
                        : 'calibrated';

                    grid.innerHTML += `
                        <div class="personal-stat-item">
                            <div class="personal-stat-value" style="${reliabilityDisplay === null ? 'color: var(--text-secondary); font-size: 1.2rem;' : ''}">${reliabilityDisplay !== null ? reliabilityDisplay : '‚Äî'}</div>
                            <div class="personal-stat-label">Reliability</div>
                            <div class="personal-stat-sublabel">${reliabilitySublabel}</div>
                        </div>
                    `;
                } else {
                    grid.innerHTML += `
                        <div class="personal-stat-item">
                            <div class="personal-stat-value" style="color: var(--text-secondary); font-size: 1.2rem;">‚Äî</div>
                            <div class="personal-stat-label">Reliability</div>
                            <div class="personal-stat-sublabel">provisional</div>
                        </div>
                    `;
                }
            } catch (e) {
                grid.innerHTML += `
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: var(--text-secondary); font-size: 1.2rem;">‚Äî</div>
                        <div class="personal-stat-label">Reliability</div>
                        <div class="personal-stat-sublabel">error</div>
                    </div>
                `;
            }
        }

        async function renderLeaderboard(fallbackAnnotators) {
            const content = document.getElementById('leaderboard-content');

            // Try to fetch leaderboard with reliability scores
            let leaderboardEntries = null;
            let calibrationThreshold = 5;

            try {
                const resp = await fetch('/api/reliability/leaderboard?sort_by=annotations');
                if (resp.ok) {
                    const data = await resp.json();
                    leaderboardEntries = data.entries;
                    calibrationThreshold = data.calibration_threshold;
                }
            } catch (e) {
                console.warn('Could not fetch reliability leaderboard, using fallback:', e);
            }

            // Use fallback if API failed
            const annotators = leaderboardEntries || fallbackAnnotators || [];

            if (annotators.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary);">No annotators yet.</p>';
                return;
            }

            // Store data for sorting (map to consistent format)
            leaderboardData = annotators.map(a => ({
                username: a.username,
                display_name: a.display_name,
                labeled: a.annotations !== undefined ? a.annotations : a.labeled,
                reliability_score: a.reliability_score,
                calibration_status: a.calibration_status || 'provisional',
                is_current_user: a.is_current_user,
                role: a.role
            }));

            // Sort data
            const sortedData = sortLeaderboardData();

            // Build table
            let html = `
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortLeaderboard('rank')">Rank</th>
                            <th onclick="sortLeaderboard('username')" class="${leaderboardSortColumn === 'username' ? 'sorted-' + leaderboardSortDirection : ''}">User</th>
                            <th onclick="sortLeaderboard('labeled')" class="${leaderboardSortColumn === 'labeled' ? 'sorted-' + leaderboardSortDirection : ''}">Annotations</th>
                            <th onclick="sortLeaderboard('reliability')" class="${leaderboardSortColumn === 'reliability' ? 'sorted-' + leaderboardSortDirection : ''}">Reliability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedData.forEach((annotator, index) => {
                const rank = index + 1;
                const isCurrentUser = annotator.is_current_user || (currentUser && annotator.username === currentUser.username);
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const displayName = annotator.display_name || annotator.username;
                const roleBadge = annotator.role === 'admin' ? '<span class="role-badge admin">Admin</span>' : '';

                // Format reliability display
                let reliabilityDisplay = '‚Äî';
                let reliabilityClass = '';
                if (annotator.calibration_status === 'calibrated' && annotator.reliability_score !== null) {
                    reliabilityDisplay = Math.round(annotator.reliability_score);
                    // Color code: green for high, yellow for medium, red for low
                    if (annotator.reliability_score >= 80) reliabilityClass = 'reliability-high';
                    else if (annotator.reliability_score >= 60) reliabilityClass = 'reliability-medium';
                    else reliabilityClass = 'reliability-low';
                } else if (annotator.calibration_status === 'provisional') {
                    reliabilityDisplay = '<span style="font-size: 0.8em; opacity: 0.7;">calibrating</span>';
                }

                html += `
                    <tr class="${isCurrentUser ? 'current-user' : ''}">
                        <td class="rank-cell ${rankClass}">${rank}</td>
                        <td>
                            <div class="user-cell">
                                <span class="display-name">${displayName}</span>
                                ${displayName !== annotator.username ? `<span class="username">@${annotator.username}</span>` : ''}
                                ${roleBadge}
                            </div>
                        </td>
                        <td class="score-cell">${annotator.labeled}</td>
                        <td class="reliability-cell ${reliabilityClass}">${reliabilityDisplay}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            content.innerHTML = html;
        }

        function sortLeaderboardData() {
            const data = [...leaderboardData];

            data.sort((a, b) => {
                let aVal, bVal;

                switch (leaderboardSortColumn) {
                    case 'username':
                        aVal = (a.display_name || a.username).toLowerCase();
                        bVal = (b.display_name || b.username).toLowerCase();
                        break;
                    case 'reliability':
                        // Calibrated with score > provisional > null
                        // Use -1 for provisional/null so they sort last when descending
                        aVal = (a.calibration_status === 'calibrated' && a.reliability_score !== null) ? a.reliability_score : -1;
                        bVal = (b.calibration_status === 'calibrated' && b.reliability_score !== null) ? b.reliability_score : -1;
                        break;
                    case 'labeled':
                    default:
                        aVal = a.labeled;
                        bVal = b.labeled;
                        break;
                }

                if (aVal < bVal) return leaderboardSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return leaderboardSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return data;
        }

        function sortLeaderboard(column) {
            if (column === 'rank') {
                // Rank always sorts by labeled desc
                leaderboardSortColumn = 'labeled';
                leaderboardSortDirection = 'desc';
            } else if (leaderboardSortColumn === column) {
                // Toggle direction
                leaderboardSortDirection = leaderboardSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                leaderboardSortColumn = column;
                // Default to descending for numeric columns, ascending for username
                leaderboardSortDirection = (column === 'labeled' || column === 'reliability') ? 'desc' : 'asc';
            }

            renderLeaderboard(leaderboardData);
        }

        async function lookupExample() {
            const dataset = document.getElementById('lookup-dataset').value.trim();
            const id = document.getElementById('lookup-id').value.trim();
            const resultArea = document.getElementById('lookup-result');

            if (!id) {
                resultArea.innerHTML = '<div class="message error">Please enter an example ID</div>';
                return;
            }

            try {
                const url = dataset ? `/api/example/${dataset}/${id}` : `/api/example/unknown/${id}`;
                const resp = await authenticatedFetch(url);

                if (!resp.ok) {
                    const err = await resp.json();
                    resultArea.innerHTML = `<div class="message error">${err.detail}</div>`;
                    return;
                }

                const data = await resp.json();
                currentExample = data;
                switchTab('labeler');
                resetLabelsForNewExample();
                renderExample();
                resetFocus();

                if (data.existing_labels && data.existing_labels.length > 0) {
                    loadExistingLabels(data.existing_labels);
                }
            } catch (e) {
                resultArea.innerHTML = `<div class="message error">Error: ${e.message}</div>`;
            }
        }

        async function exportLabels() {
            try {
                const resp = await authenticatedFetch('/api/export');
                const data = await resp.json();

                const blob = new Blob(
                    [data.data.map(d => JSON.stringify(d)).join('\n')],
                    { type: 'application/jsonl' }
                );
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nli_span_labels_${new Date().toISOString().split('T')[0]}.jsonl`;
                a.click();
                URL.revokeObjectURL(url);

                showMessage(`Exported ${data.count} labeled examples`, 'success');
            } catch (e) {
                showMessage(`Export error: ${e.message}`, 'error');
            }
        }

        function showStats() { switchTab('stats'); }

        // ============================================================================
        // Admin Dashboard
        // ============================================================================

        let adminDashboardData = null;

        function updateAdminTabVisibility() {
            const adminTabBtn = document.getElementById('admin-tab-btn');
            if (currentUser && currentUser.role === 'admin') {
                adminTabBtn.classList.remove('hidden');
            } else {
                adminTabBtn.classList.add('hidden');
            }
        }

        async function loadAdminDashboard() {
            if (!currentUser || currentUser.role !== 'admin') {
                return;
            }

            const dataset = document.getElementById('admin-dataset-filter').value;
            const days = document.getElementById('admin-days-filter').value;

            try {
                const params = new URLSearchParams();
                if (dataset) params.append('dataset', dataset);
                params.append('days', days);

                const resp = await fetch(`/api/admin/dashboard?${params}`);
                if (!resp.ok) {
                    throw new Error('Failed to load dashboard');
                }

                adminDashboardData = await resp.json();
                renderAdminDashboard(adminDashboardData);

                // Populate dataset filter if not already done
                const datasetFilter = document.getElementById('admin-dataset-filter');
                if (datasetFilter.options.length <= 1 && adminDashboardData.datasets) {
                    adminDashboardData.datasets.forEach(ds => {
                        const opt = document.createElement('option');
                        opt.value = ds.name;
                        opt.textContent = ds.name;
                        datasetFilter.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Admin dashboard error:', e);
                document.getElementById('admin-overview').innerHTML =
                    `<div class="message error">Failed to load dashboard: ${e.message}</div>`;
            }
        }

        function renderAdminDashboard(data) {
            // Overview cards
            const overview = data.overview;
            document.getElementById('admin-overview').innerHTML = `
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.total_annotations.toLocaleString()}</div>
                    <div class="admin-stat-label">Total Annotations</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.annotated_examples.toLocaleString()}</div>
                    <div class="admin-stat-label">Examples Annotated</div>
                    <div class="admin-stat-sublabel">${overview.completion_pct}% of ${overview.total_examples.toLocaleString()}</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.total_annotators}</div>
                    <div class="admin-stat-label">Total Annotators</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.active_users_24h}</div>
                    <div class="admin-stat-label">Active (24h)</div>
                    <div class="admin-stat-sublabel">${overview.active_users_7d} in last 7d</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${data.pools.test}</div>
                    <div class="admin-stat-label">Test Pool</div>
                    <div class="admin-stat-sublabel">High consensus</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${data.pools.building}</div>
                    <div class="admin-stat-label">Building Pool</div>
                    <div class="admin-stat-sublabel">In progress</div>
                </div>
            `;

            // Activity chart
            renderActivityChart(data.activity.daily);

            // Dataset table
            renderDatasetTable(data.datasets);

            // Quality indicators
            renderQualityIndicators(data.quality);

            // Annotator table
            renderAnnotatorTable(data.annotators);

            // Hotspots table
            renderHotspotsTable(data.quality.disagreement_hotspots);
        }

        function renderActivityChart(daily) {
            const container = document.getElementById('admin-activity-chart');

            if (!daily || daily.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; width: 100%;">No activity data</div>';
                return;
            }

            const maxCount = Math.max(...daily.map(d => d.count), 1);
            const barWidth = Math.max(4, Math.floor((container.offsetWidth - 20) / daily.length) - 2);

            container.innerHTML = daily.map(d => {
                const height = Math.max(4, (d.count / maxCount) * 180);
                return `
                    <div class="activity-bar" style="height: ${height}px; width: ${barWidth}px;">
                        <span class="activity-bar-label">${d.date}: ${d.count}</span>
                    </div>
                `;
            }).join('');
        }

        function renderDatasetTable(datasets) {
            const container = document.getElementById('admin-datasets-table');

            if (!datasets || datasets.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">No datasets</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Dataset</th>
                            <th>Progress</th>
                            <th>Annotations</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${datasets.map(ds => `
                            <tr>
                                <td><strong>${ds.name}</strong></td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${ds.completion_pct}%"></div>
                                    </div>
                                    ${ds.completion_pct}%
                                </td>
                                <td>${ds.total_annotations.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderQualityIndicators(quality) {
            const container = document.getElementById('admin-quality-indicators');

            container.innerHTML = `
                <div class="quality-stat">
                    <span class="quality-stat-label">Examples with overlap (2+ annotators)</span>
                    <span class="quality-stat-value">${quality.examples_with_overlap.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Examples at consensus threshold</span>
                    <span class="quality-stat-value">${quality.examples_at_consensus.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Custom labels used</span>
                    <span class="quality-stat-value">${quality.custom_label_usage.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Disagreement hotspots</span>
                    <span class="quality-stat-value" style="color: ${quality.disagreement_hotspots.length > 0 ? '#f87171' : '#4ade80'}">
                        ${quality.disagreement_hotspots.length}
                    </span>
                </div>
            `;
        }

        function renderAnnotatorTable(annotators) {
            const container = document.getElementById('admin-annotators-table');

            if (!annotators || annotators.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">No annotators</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Annotator</th>
                            <th>Role</th>
                            <th>Annotations</th>
                            <th>Reliability</th>
                            <th>Last Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${annotators.map(a => {
                            let reliabilityBadge;
                            if (a.calibration_status === 'provisional') {
                                reliabilityBadge = '<span class="reliability-badge calibrating-badge">Calibrating</span>';
                            } else if (a.reliability_score !== null) {
                                const score = Math.round(a.reliability_score);
                                let badgeClass = 'reliability-low';
                                if (score >= 80) badgeClass = 'reliability-high';
                                else if (score >= 60) badgeClass = 'reliability-medium';
                                reliabilityBadge = `<span class="reliability-badge ${badgeClass}">${score}</span>`;
                            } else {
                                reliabilityBadge = '<span style="color: var(--text-secondary);">‚Äî</span>';
                            }

                            const roleBadge = a.role === 'admin' ? '<span class="role-badge admin">Admin</span>' : '';
                            const lastSeen = a.last_seen ? new Date(a.last_seen).toLocaleDateString() : '‚Äî';

                            return `
                                <tr>
                                    <td><strong>${a.display_name || a.username}</strong> ${roleBadge}</td>
                                    <td>${a.role}</td>
                                    <td>${a.annotations.toLocaleString()}</td>
                                    <td>${reliabilityBadge}</td>
                                    <td>${lastSeen}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderHotspotsTable(hotspots) {
            const container = document.getElementById('admin-hotspots-table');

            if (!hotspots || hotspots.length === 0) {
                container.innerHTML = '<div style="color: #4ade80; padding: 20px; text-align: center;">‚úì No disagreement hotspots found</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Example ID</th>
                            <th>Dataset</th>
                            <th>Annotations</th>
                            <th>Agreement</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hotspots.map(h => `
                            <tr class="hotspot-row" onclick="lookupHotspot('${h.example_id}')">
                                <td><code>${h.example_id}</code></td>
                                <td>${h.dataset}</td>
                                <td>${h.annotation_count}</td>
                                <td style="color: #f87171">${h.agreement_score !== null ? (h.agreement_score * 100).toFixed(1) + '%' : '‚Äî'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function lookupHotspot(exampleId) {
            document.getElementById('lookup-id').value = exampleId;
            switchTab('lookup');
            lookupExample();
        }

        // Update admin tab visibility when user changes
        const originalUpdateUserDisplay = updateUserDisplay;
        updateUserDisplay = function() {
            originalUpdateUserDisplay();
            updateAdminTabVisibility();
        };

        // Load admin dashboard when tab is switched
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'admin') {
                loadAdminDashboard();
            }
        };
    </script>
</body>
</html>
