<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLI Span Labeler</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #4a9eff;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #3a8eef; }
        .btn-success { background: var(--success); color: #1a1a2e; }
        .btn-warning { background: var(--warning); color: #1a1a2e; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #444; color: white; }
        .btn-small { padding: 4px 10px; font-size: 0.8rem; }

        .card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .example-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .example-id {
            font-family: monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .gold-label {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .gold-label.entailment { background: #22c55e33; color: #4ade80; }
        .gold-label.neutral { background: #eab30833; color: #fbbf24; }
        .gold-label.contradiction { background: #ef444433; color: #f87171; }

        .text-section {
            margin-bottom: 20px;
        }

        .text-section.active-section {
            background: rgba(74, 158, 255, 0.05);
            border-radius: 8px;
            margin: -8px;
            padding: 8px;
            margin-bottom: 12px;
        }

        .text-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .text-section.active-section .text-label {
            color: var(--accent);
        }

        .text-content {
            line-height: 2.5;
            font-size: 1.1rem;
        }

        /* Word container for multi-label support */
        .word-container {
            display: inline-block;
            position: relative;
            margin: 2px 0;
            vertical-align: top;
        }

        /* Word-initial tokens (not subwords) get left margin to separate from previous word */
        .word-container:not(.subword) {
            margin-left: 6px;
        }

        /* First token in a text block doesn't need left margin */
        .words:first-child .word-container:first-child,
        .word-container:first-child {
            margin-left: 0;
        }

        /* Subword tokens connect tightly to previous token */
        .word-container.subword {
            margin-left: 1px;
        }

        .word {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
            position: relative;
            z-index: 1;
        }

        /* Subword tokens get a left connector */
        .word.subword {
            padding-left: 3px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* Subword indicator */
        .word.subword::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 2px;
            background: var(--text-secondary);
            opacity: 0.5;
        }

        .word:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Keyboard focus indicator */
        .word.keyboard-focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            background: rgba(74, 158, 255, 0.2);
        }

        /* Label dots below words */
        .label-dots {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 2px;
            min-height: 8px;
        }

        .label-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .label-dot.active-label {
            width: 8px;
            height: 8px;
            box-shadow: 0 0 4px currentColor;
        }

        /* Active label highlight on word */
        .word.has-active-label {
            border-width: 2px;
            border-style: solid;
        }

        /* Color classes */
        .color-0 { background: rgba(59, 130, 246, 0.3); border-color: #3b82f6; color: #3b82f6; }
        .color-1 { background: rgba(139, 92, 246, 0.3); border-color: #8b5cf6; color: #8b5cf6; }
        .color-2 { background: rgba(6, 182, 212, 0.3); border-color: #06b6d4; color: #06b6d4; }
        .color-3 { background: rgba(34, 197, 94, 0.3); border-color: #22c55e; color: #22c55e; }
        .color-4 { background: rgba(234, 179, 8, 0.3); border-color: #eab308; color: #eab308; }
        .color-5 { background: rgba(249, 115, 22, 0.3); border-color: #f97316; color: #f97316; }
        .color-6 { background: rgba(74, 222, 128, 0.3); border-color: #4ade80; color: #4ade80; }
        .color-7 { background: rgba(251, 191, 36, 0.3); border-color: #fbbf24; color: #fbbf24; }
        .color-8 { background: rgba(248, 113, 113, 0.3); border-color: #f87171; color: #f87171; }

        /* Auto-spans display (read-only Tier 0/1 labels) */
        .auto-spans-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            border-left: 3px solid var(--text-secondary);
        }

        .auto-spans-header {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-spans-header::before {
            content: 'ðŸ¤–';
            font-size: 1rem;
        }

        .auto-spans-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .auto-span-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(100, 100, 100, 0.3);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .auto-span-tag .label-name {
            font-weight: 500;
        }

        .auto-span-tag .token-list {
            color: #aaa;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .auto-span-tag.tier0 {
            border: 1px solid rgba(100, 100, 100, 0.5);
        }

        .auto-span-tag.tier1 {
            border: 1px solid rgba(139, 92, 246, 0.5);
            background: rgba(139, 92, 246, 0.15);
        }

        .auto-spans-empty {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Difficulty Justification Section (conditional spans) */
        .difficulty-justifications-section {
            margin-top: 15px;
            border-left: 3px solid var(--accent);
        }

        .difficulty-justification-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .difficulty-justification-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .difficulty-justification-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .difficulty-justification-item.active {
            border-color: var(--accent);
            background: rgba(74, 158, 255, 0.15);
        }

        .justification-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .justification-info {
            flex: 1;
            min-width: 0;
        }

        .justification-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .justification-prompt {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .justification-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .labels-section { margin-top: 20px; }

        .labels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .labels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .label-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .label-item:hover { background: rgba(0, 0, 0, 0.3); }

        .label-item.active {
            border-color: var(--accent);
            background: rgba(74, 158, 255, 0.1);
        }

        .label-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .label-name {
            flex-grow: 1;
            font-size: 0.9rem;
        }

        .label-name input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 100%;
            font-size: 0.9rem;
        }

        .label-name input:focus {
            outline: none;
            border-bottom: 1px solid var(--accent);
        }

        .label-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .label-key {
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .complexity-section { margin-top: 20px; }

        .complexity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .complexity-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid transparent;
            transition: border-color 0.2s, background 0.2s;
        }

        .complexity-item.focused {
            border-color: var(--accent);
            background: rgba(74, 158, 255, 0.1);
        }

        .complexity-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-key-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .complexity-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .complexity-input input[type="range"] {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            -webkit-appearance: none;
            background: #333;
        }

        .complexity-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .complexity-input input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: center;
        }

        .complexity-input input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Hide number input spinners */
        .complexity-input input[type="number"]::-webkit-outer-spin-button,
        .complexity-input input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .message {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .message.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .message.error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .dataset-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .dataset-selector select {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        .instructions {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .instructions strong { color: var(--accent); }

        /* Tokenizer info badge */
        .tokenizer-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .tokenizer-badge::before {
            content: 'ðŸ”¤';
        }

        /* User info badge */
        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-badge .username {
            font-weight: 600;
        }

        .user-badge .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 4px;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .user-badge .logout-btn:hover {
            opacity: 1;
            color: var(--danger);
        }

        /* Help button */
        .help-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: rgba(74, 158, 255, 0.2);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Legend for label colors */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal.modal-wide {
            max-width: 700px;
        }

        .modal.modal-tall {
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: var(--accent);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .modal-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .modal-tab:hover { color: var(--text-primary); }
        .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .modal-actions {
            margin-top: 20px;
        }

        .modal-actions .btn {
            width: 100%;
            padding: 12px;
        }

        .anonymous-note {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        /* Help modal styles */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .shortcuts-section h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 2px 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .shortcut-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-relative {
            position: relative;
        }

        /* Help content styles */
        .help-content {
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .help-content h3 {
            color: var(--accent);
            margin: 20px 0 10px 0;
            font-size: 1rem;
        }

        .help-content h3:first-child {
            margin-top: 0;
        }

        .help-content p {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .help-content ul, .help-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .help-content li {
            margin-bottom: 6px;
        }

        .help-content strong {
            color: var(--text-primary);
        }

        .help-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .help-content .tip {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
        }

        .help-content .label-example {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 6px;
            margin: 2px;
        }

        .help-content .label-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .help-content .nli-label {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
        }

        .help-content .nli-label.entailment { background: #22c55e33; color: #4ade80; }
        .help-content .nli-label.neutral { background: #eab30833; color: #fbbf24; }
        .help-content .nli-label.contradiction { background: #ef444433; color: #f87171; }

        .help-content .api-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            margin: 5px 5px 5px 0;
            transition: background 0.2s;
        }

        .help-content .api-link:hover {
            background: rgba(74, 158, 255, 0.25);
        }

        .help-tab-content {
            display: none;
        }

        .help-tab-content.active {
            display: block;
        }

        /* Leaderboard styles */
        .leaderboard-section {
            margin-top: 30px;
        }

        .leaderboard-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .leaderboard-table th:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .leaderboard-table th.sorted-asc::after {
            content: ' â–²';
            font-size: 0.7rem;
        }

        .leaderboard-table th.sorted-desc::after {
            content: ' â–¼';
            font-size: 0.7rem;
        }

        .leaderboard-table tbody tr {
            transition: background 0.2s;
        }

        .leaderboard-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-table tbody tr.current-user {
            background: rgba(74, 222, 128, 0.15);
            border-left: 3px solid var(--success);
        }

        .leaderboard-table tbody tr.current-user:hover {
            background: rgba(74, 222, 128, 0.2);
        }

        .rank-cell {
            font-weight: 600;
            color: var(--text-secondary);
            width: 60px;
        }

        .rank-cell.rank-1 { color: #ffd700; }
        .rank-cell.rank-2 { color: #c0c0c0; }
        .rank-cell.rank-3 { color: #cd7f32; }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-cell .display-name {
            font-weight: 500;
        }

        .user-cell .username {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .role-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.admin {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .score-cell {
            font-weight: 600;
            color: var(--accent);
        }

        .reliability-cell {
            color: var(--text-secondary);
            font-style: italic;
        }

        .reliability-cell.reliability-high {
            color: var(--success);
            font-style: normal;
            font-weight: 600;
        }

        .reliability-cell.reliability-medium {
            color: #f59e0b;
            font-style: normal;
            font-weight: 500;
        }

        .reliability-cell.reliability-low {
            color: var(--error);
            font-style: normal;
            font-weight: 500;
        }

        /* Personal stats card */
        .personal-stats-card {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(74, 222, 128, 0.1));
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .personal-stats-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .personal-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .personal-stat-item {
            text-align: center;
        }

        .personal-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .personal-stat-value.rank {
            color: var(--success);
        }

        .personal-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .personal-stat-sublabel {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Admin Dashboard Styles */
        .admin-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .admin-stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .admin-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .admin-stat-sublabel {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .admin-table tbody tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            width: 100px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .activity-bar {
            background: var(--accent-color);
            min-width: 4px;
            border-radius: 2px 2px 0 0;
            transition: height 0.3s ease;
            position: relative;
        }

        .activity-bar:hover {
            opacity: 0.8;
        }

        .activity-bar-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            padding: 2px 4px;
            background: var(--card-bg);
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .activity-bar:hover .activity-bar-label {
            opacity: 1;
        }

        .quality-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .quality-stat:last-child {
            border-bottom: none;
        }

        .quality-stat-label {
            color: var(--text-secondary);
        }

        .quality-stat-value {
            font-weight: 600;
        }

        .reliability-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .reliability-high {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .reliability-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .reliability-low {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .calibrating-badge {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .hotspot-row {
            cursor: pointer;
        }

        .hotspot-row:hover {
            background: rgba(248, 113, 113, 0.1) !important;
        }

        /* Training Mode Styles */
        .training-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .training-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .training-header h2 {
            color: var(--accent);
        }

        .training-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar-container {
            width: 200px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .training-instructions {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
        }

        .training-instructions p {
            margin-bottom: 10px;
        }

        .training-instructions p:last-child {
            margin-bottom: 0;
        }

        .training-feedback {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .accuracy-badge {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .accuracy-badge.good {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }

        .accuracy-badge.fair {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }

        .accuracy-badge.poor {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger);
        }

        .feedback-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .feedback-column {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .feedback-column h4 {
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .feedback-score-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feedback-score-row.match {
            color: var(--success);
        }

        .feedback-score-row.close {
            color: var(--warning);
        }

        .feedback-score-row.off {
            color: var(--danger);
        }

        .feedback-explanation {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .training-complete {
            text-align: center;
            padding: 40px;
        }

        .training-complete h2 {
            color: var(--success);
            margin-bottom: 20px;
        }

        .training-complete p {
            margin-bottom: 15px;
        }

        /* Gold Examples Admin Tab */
        .gold-examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .gold-example-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid var(--warning);
        }

        .gold-example-card .example-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .gold-example-card .explanation {
            font-style: italic;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gold-scores {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .gold-score-chip {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay hidden" onclick="handleAuthOverlayClick(event)">
        <div class="modal">
            <button id="auth-modal-close" class="modal-close hidden" onclick="dismissAuthModal()">&times;</button>
            <h2>NLI Span Labeler</h2>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="modal-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required minlength="6" autocomplete="current-password">
                </div>
                <div id="login-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="register-display">Display Name (optional)</label>
                    <input type="text" id="register-display" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required minlength="6" autocomplete="new-password">
                </div>
                <div id="register-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-success">Create Account</button>
                </div>
            </form>

            <div id="anonymous-note" class="anonymous-note hidden">
                Running in anonymous mode. No login required.
            </div>

            <div id="dismiss-note" class="anonymous-note hidden">
                <p style="margin-bottom: 8px;">Anonymous submissions are enabled.</p>
                <button type="button" class="btn btn-secondary" onclick="dismissAuthModal()">Continue as Anonymous</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal modal-wide modal-tall modal-relative">
            <button class="modal-close" onclick="hideHelpModal()">&times;</button>
            <h2>ðŸ“– Help & Documentation</h2>
            
            <div class="modal-tabs" id="help-tabs">
                <button class="modal-tab active" onclick="switchHelpTab('overview')">Overview</button>
                <button class="modal-tab" onclick="switchHelpTab('rubric')">Rubric</button>
                <button class="modal-tab" onclick="switchHelpTab('labels')">Labels</button>
                <button class="modal-tab" onclick="switchHelpTab('shortcuts')">Shortcuts</button>
                <button class="modal-tab" onclick="switchHelpTab('api')">API</button>
            </div>

            <!-- Overview Tab -->
            <div id="help-overview" class="help-tab-content active">
                <div class="help-content">
                    <h3>What is NLI?</h3>
                    <p>
                        <strong>Natural Language Inference (NLI)</strong> is a task where you determine the logical relationship 
                        between two sentences: a <strong>premise</strong> and a <strong>hypothesis</strong>.
                    </p>
                    <p>The three possible relationships are:</p>
                    <ul>
                        <li><span class="nli-label entailment">Entailment</span> - The hypothesis is definitely true given the premise</li>
                        <li><span class="nli-label neutral">Neutral</span> - The hypothesis might be true, but we can't tell from the premise</li>
                        <li><span class="nli-label contradiction">Contradiction</span> - The hypothesis is definitely false given the premise</li>
                    </ul>

                    <h3>Your Task</h3>
                    <p>
                        As an annotator, you'll do two things for each example:
                    </p>
                    <ol>
                        <li><strong>Mark relevant spans</strong> - Click on tokens (words) that are important for understanding the NLI relationship</li>
                        <li><strong>Rate complexity</strong> - Score how difficult the example is across six dimensions</li>
                    </ol>

                    <h3>Annotation Workflow</h3>
                    <ol>
                        <li><strong>Read the example</strong> - Understand the premise and hypothesis</li>
                        <li><strong>Select a label</strong> - Click a label or press <code>1-9</code> to choose what you're marking</li>
                        <li><strong>Mark tokens</strong> - Click tokens or use <code>j/k</code> + <code>Space</code> to select them</li>
                        <li><strong>Adjust complexity scores</strong> - Use the sliders to rate difficulty</li>
                        <li><strong>Save</strong> - Press <code>Enter</code> or click "Save & Next"</li>
                    </ol>

                    <div class="tip">
                        <strong>Tip:</strong> You can mark the same token with multiple labels! Colored dots below each token 
                        show all labels applied to it.
                    </div>

                    <h3>Tokenization</h3>
                    <p>
                        Text is split using <strong>WordPiece tokenization</strong> (the same as ModernBERT). 
                        Sometimes words are split into subword tokens, shown connected with a small dash.
                        For example, "running" might become "run" + "##ning".
                    </p>
                </div>
            </div>

            <!-- Rubric Tab -->
            <div id="help-rubric" class="help-tab-content">
                <div class="help-content">
                    <h3>The Core Principle</h3>
                    <div class="tip" style="font-size: 1.1em; padding: 15px;">
                        <strong>Mark the smallest set of tokens that, if removed, would change the NLI label.</strong>
                    </div>
                    <p>Mental test: "If I deleted this word, would the relationship still hold?"</p>

                    <h3>Entailment Spans</h3>
                    <p><strong>Definition:</strong> Tokens that establish the logical bridge between premise and hypothesis.</p>

                    <p><strong>What to Mark:</strong></p>
                    <ul>
                        <li><strong>Aligned entities/concepts</strong> â€” Tokens in BOTH sentences referring to the same thing
                            <br><code>P: A [man] plays [guitar]</code> â†’ <code>H: A [person] plays [music]</code>
                            <br>Mark: manâ†”person, guitarâ†”music</li>
                        <li><strong>Entailing predicates</strong> â€” Verbs in premise that logically imply hypothesis
                            <br><code>P: The cat is [sleeping]</code> â†’ <code>H: The cat is [resting]</code></li>
                        <li><strong>Scope markers</strong> â€” Words showing premise is more specific
                            <br><code>P: [Three] dogs</code> â†’ <code>H: [Some] dogs</code></li>
                    </ul>
                    <p><strong>Do NOT Mark:</strong> Determiners (a, the) unless they change meaning; punctuation; background details irrelevant to the inference.</p>

                    <h3>Contradiction Spans</h3>
                    <p><strong>Definition:</strong> Tokens that cannot both be true simultaneously.</p>

                    <p><strong>What to Mark:</strong></p>
                    <ul>
                        <li><strong>Direct negation</strong> â€” <code>P: [open]</code> â†” <code>H: [closed]</code></li>
                        <li><strong>Incompatible quantities</strong> â€” <code>P: [All] students</code> â†” <code>H: [No] students</code></li>
                        <li><strong>Mutually exclusive predicates</strong> â€” <code>P: [standing]</code> â†” <code>H: [sitting]</code></li>
                        <li><strong>Entity mismatch</strong> â€” <code>P: [John] won</code> â†” <code>H: [Mary] won</code> (if same event)</li>
                    </ul>
                    <p><strong>Do NOT Mark:</strong> Tokens that differ but aren't contradictory; background tokens consistent between both.</p>

                    <h3>Neutral Spans</h3>
                    <p><strong>Definition:</strong> Tokens introducing information not addressed by the other sentence. This is the trickiest categoryâ€”neutral means "could be true or false given the premise."</p>

                    <p><strong>What to Mark:</strong></p>
                    <ul>
                        <li><strong>Ungrounded details in hypothesis</strong>
                            <br><code>P: A woman is walking</code> â†’ <code>H: A woman is walking to [the store]</code>
                            <br>Mark (H): "the store" â€” premise doesn't say where</li>
                        <li><strong>Unmentioned entities</strong>
                            <br><code>P: Two men are talking</code> â†’ <code>H: Two [friends] are talking</code>
                            <br>Mark: "friends" â€” relationship not established</li>
                        <li><strong>Specificity gap</strong>
                            <br><code>P: A person is eating</code> â†’ <code>H: A person is eating [breakfast]</code>
                            <br>Mark: "breakfast" â€” meal type not specified</li>
                    </ul>
                    <p><strong>Decision test:</strong> "Does the premise give evidence for or against this token?" If neither â†’ neutral span.</p>

                    <h3>Decision Tree</h3>
                    <div style="background: var(--surface); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; line-height: 1.6;">
                        "Should I mark this token?"<br>
                        &nbsp;&nbsp;â””â–º Would removing it change the NLI label?<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;YES â†’ Mark it<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO â†’ Don't mark<br><br>
                        "Is this entailment, contradiction, or neutral?"<br>
                        &nbsp;&nbsp;â””â–º Can I be 100% certain of hypothesis from premise alone?<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;YES + matches â†’ ENTAILMENT<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;YES + conflicts â†’ CONTRADICTION<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO â†’ NEUTRAL<br><br>
                        "Multiple valid span sets?"<br>
                        &nbsp;&nbsp;â””â–º Flag it, pick one consistently, note in rationale
                    </div>

                    <div class="tip" style="margin-top: 15px;">
                        <strong>Key Insight:</strong> Focus on the <em>relationship</em> between sentences, not just what each says individually. The same token might be neutral in one pair but contradictory in another.
                    </div>
                </div>
            </div>

            <!-- Labels Tab -->
            <div id="help-labels" class="help-tab-content">
                <div class="help-content">
                    <h3>Difficulty Dimension Labels</h3>
                    <p>Use these labels to mark tokens that contribute to different types of difficulty:</p>
                    
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #3b82f6;"></span> reasoning</span>
                        Tokens requiring logical inference, deduction, or multi-step reasoning to understand.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #8b5cf6;"></span> creativity</span>
                        Tokens requiring imaginative or non-literal interpretation (metaphors, analogies, figurative language).
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #06b6d4;"></span> domain_knowledge</span>
                        Tokens requiring specialized knowledge (scientific, technical, cultural, etc.).
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #22c55e;"></span> contextual</span>
                        Tokens that depend on implicit context not explicitly stated in the text.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #eab308;"></span> constraints</span>
                        Tokens representing conditions, limitations, or requirements that must be tracked.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #f97316;"></span> ambiguity</span>
                        Tokens that are ambiguous or could be interpreted multiple ways.
                    </p>

                    <h3>NLI Relationship Labels</h3>
                    <p>Use these labels to mark tokens that are key evidence for the NLI relationship:</p>
                    
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #4ade80;"></span> entailment</span>
                        Tokens that support or prove the hypothesis follows from the premise.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #fbbf24;"></span> neutral</span>
                        Tokens that introduce information not determinable from the premise.
                    </p>
                    <p>
                        <span class="label-example"><span class="label-dot" style="background: #f87171;"></span> contradiction</span>
                        Tokens that conflict or are inconsistent between premise and hypothesis.
                    </p>

                    <h3>Custom Labels</h3>
                    <p>
                        Click <strong>"+ New Label"</strong> to create custom labels for patterns you want to track.
                        You can rename any label by clicking on its name.
                    </p>

                    <h3>Complexity Scores</h3>
                    <p>
                        Rate each example on a scale of <strong>0-10</strong> for six dimensions:
                    </p>
                    <ul>
                        <li><strong>Reasoning</strong> - How much logical inference is required?</li>
                        <li><strong>Creativity</strong> - How much imaginative interpretation is needed?</li>
                        <li><strong>Domain Knowledge</strong> - How much specialized knowledge is required?</li>
                        <li><strong>Contextual</strong> - How much does it depend on implicit context?</li>
                        <li><strong>Constraints</strong> - How many conditions must be tracked?</li>
                        <li><strong>Ambiguity</strong> - How debatable is the answer?</li>
                    </ul>

                    <div class="tip">
                        <strong>Tip:</strong> Don't overthink the scores! Quick intuitive ratings are fine. 
                        The goal is relative difficulty, not precise measurement.
                    </div>
                </div>
            </div>

            <!-- Shortcuts Tab -->
            <div id="help-shortcuts" class="help-tab-content">
                <div class="help-content">
                    <div class="shortcuts-grid">
                        <div class="shortcuts-section">
                            <h4>Navigation</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">j</span> <span class="shortcut-key">â†’</span></span>
                                <span class="shortcut-desc">Next word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">k</span> <span class="shortcut-key">â†</span></span>
                                <span class="shortcut-desc">Previous word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Tab</span></span>
                                <span class="shortcut-desc">Switch premise/hypothesis</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Home</span></span>
                                <span class="shortcut-desc">First word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">End</span></span>
                                <span class="shortcut-desc">Last word</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Labeling</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">1</span>-<span class="shortcut-key">9</span></span>
                                <span class="shortcut-desc">Toggle label on focused word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Space</span></span>
                                <span class="shortcut-desc">Toggle active label on word</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">c</span></span>
                                <span class="shortcut-desc">Clear all selections</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Difficulty Sliders</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Shift</span>+<span class="shortcut-key">1</span>-<span class="shortcut-key">6</span></span>
                                <span class="shortcut-desc">Focus slider (R/C/D/X/N/A)</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">+</span> <span class="shortcut-key">-</span></span>
                                <span class="shortcut-desc">Adjust focused slider Â±1</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">0</span>-<span class="shortcut-key">9</span></span>
                                <span class="shortcut-desc">Set slider value directly</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Actions</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Enter</span></span>
                                <span class="shortcut-desc">Save & next example</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">Esc</span></span>
                                <span class="shortcut-desc">Skip example</span>
                            </div>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">n</span></span>
                                <span class="shortcut-desc">Load next example</span>
                            </div>
                        </div>
                        <div class="shortcuts-section">
                            <h4>Help</h4>
                            <div class="shortcut-row">
                                <span class="shortcut-keys"><span class="shortcut-key">?</span></span>
                                <span class="shortcut-desc">Toggle this help</span>
                            </div>
                        </div>
                    </div>

                    <div class="tip" style="margin-top: 20px;">
                        <strong>Power User Workflow:</strong> Press <code>1</code> to select "reasoning",
                        use <code>j/k</code> to navigate, <code>Space</code> to mark. Set difficulty with
                        <code>Shift+1</code> then type <code>7</code>. Hit <code>Enter</code> to save.
                        Full keyboard annotation, no mouse required!
                    </div>
                </div>
            </div>

            <!-- API Tab -->
            <div id="help-api" class="help-tab-content">
                <div class="help-content">
                    <h3>API Documentation</h3>
                    <p>
                        For programmatic access to the annotation data, the API is fully documented with interactive endpoints:
                    </p>
                    
                    <p>
                        <a href="/docs" target="_blank" class="api-link">ðŸ“˜ Swagger UI (/docs)</a>
                        <a href="/redoc" target="_blank" class="api-link">ðŸ“• ReDoc (/redoc)</a>
                    </p>

                    <h3>Key Endpoints</h3>
                    <ul>
                        <li><code>GET /api/next</code> - Get the next unlabeled example</li>
                        <li><code>GET /api/example/{dataset}/{id}</code> - Get a specific example</li>
                        <li><code>POST /api/label</code> - Submit annotations</li>
                        <li><code>GET /api/stats</code> - Get annotation statistics</li>
                        <li><code>GET /api/export</code> - Export all annotations as JSONL</li>
                    </ul>

                    <h3>Authentication</h3>
                    <p>
                        The API uses session-based authentication via cookies. Log in through the web interface 
                        or use the <code>/api/auth/login</code> endpoint.
                    </p>
                    <p>
                        If the server is running with <code>ANONYMOUS_MODE=1</code>, no authentication is required.
                    </p>

                    <h3>Export Format</h3>
                    <p>
                        Exported data is in JSONL format with each line containing:
                    </p>
                    <ul>
                        <li>Example ID, dataset, premise, hypothesis, gold label</li>
                        <li>Annotator information</li>
                        <li>Complexity scores for all six dimensions</li>
                        <li>Span labels with token indices and character offsets</li>
                        <li>Tokenizer model used</li>
                    </ul>
                </div>
            </div>

            <p style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                Press <span class="shortcut-key">?</span> or <span class="shortcut-key">Esc</span> to close
            </p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>NLI Span Labeler</h1>
            <div class="header-buttons">
                <span class="tokenizer-badge" id="tokenizer-badge">Loading...</span>
                <span id="user-info" class="user-badge hidden">
                    <span class="username" id="username-display"></span>
                    <button class="logout-btn" onclick="handleLogout()" title="Logout">âœ•</button>
                </span>
                <button class="help-btn" onclick="showHelpModal()" title="Help & documentation (?)">?</button>
                <button class="btn btn-secondary" onclick="showStats()">Stats</button>
                <button class="btn btn-secondary" onclick="exportLabels()">Export</button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="labeler" onclick="switchTab('labeler')">Labeler</button>
            <button class="nav-tab" data-tab="stats" onclick="switchTab('stats')">Statistics</button>
            <button class="nav-tab" data-tab="lookup" onclick="switchTab('lookup')">Lookup</button>
            <button class="nav-tab admin-only hidden" data-tab="admin" id="admin-tab-btn" onclick="switchTab('admin')">ðŸ“Š Admin Dashboard</button>
            <button class="nav-tab admin-only hidden" data-tab="quality-review" onclick="switchTab('quality-review')">ðŸ” Quality Review</button>
            <button class="nav-tab admin-only hidden" data-tab="gold-examples" onclick="switchTab('gold-examples')">ðŸ“š Gold Examples</button>
            <button class="nav-tab admin-only hidden" data-tab="flagged" onclick="switchTab('flagged')">ðŸš© Flagged</button>
        </div>

        <!-- Training Mode Overlay -->
        <div id="training-overlay" class="training-overlay hidden">
            <div class="training-container">
                <div class="training-header">
                    <h2>ðŸŽ“ Training Mode</h2>
                    <div class="training-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="training-progress-bar" style="width: 0%"></div>
                        </div>
                        <span id="training-progress-text">0 / 5 completed</span>
                    </div>
                </div>

                <div class="training-instructions card">
                    <p>Welcome! Before you start annotating, please complete a short training to familiarize yourself with the labeling process.</p>
                    <p>You'll annotate <strong id="training-required-count">5</strong> gold-standard examples and receive feedback on each one.</p>
                </div>

                <div id="training-example-area" class="card">
                    <div class="loading">Loading training example...</div>
                </div>

                <!-- Training Labels Section -->
                <div class="card labels-section">
                    <div class="labels-header">
                        <h3>Span Labels</h3>
                    </div>
                    <div class="labels-grid" id="training-labels-grid"></div>
                    <div class="legend" id="training-legend"></div>
                </div>

                <!-- Training Complexity Scores -->
                <div class="card complexity-section">
                    <h3 style="margin-bottom: 15px;">Complexity Scores (0-10)</h3>
                    <div class="complexity-grid" id="training-complexity-grid"></div>
                </div>

                <!-- Training Actions -->
                <div class="actions">
                    <button class="btn btn-success" onclick="submitTrainingAnnotation()">Submit & Get Feedback</button>
                </div>

                <!-- Feedback Panel (shown after submission) -->
                <div id="training-feedback" class="training-feedback hidden">
                    <div class="feedback-header">
                        <h3>Feedback</h3>
                        <span class="accuracy-badge" id="feedback-accuracy">0%</span>
                    </div>
                    <div class="feedback-comparison">
                        <div class="feedback-column">
                            <h4>Your Scores</h4>
                            <div id="feedback-your-scores"></div>
                        </div>
                        <div class="feedback-column">
                            <h4>Gold Standard</h4>
                            <div id="feedback-gold-scores"></div>
                        </div>
                    </div>
                    <div class="feedback-explanation" id="feedback-explanation"></div>
                    <button class="btn btn-primary" onclick="continueTraining()">Continue</button>
                </div>

                <!-- Training Complete Panel -->
                <div id="training-complete" class="training-complete hidden">
                    <h2>ðŸŽ‰ Training Complete!</h2>
                    <p>Your training accuracy: <strong id="training-final-accuracy">0%</strong></p>
                    <p>You can now start annotating real examples.</p>
                    <button class="btn btn-success" onclick="finishTraining()">Start Annotating</button>
                </div>
            </div>
        </div>

        <!-- Labeler Tab -->
        <div id="labeler-tab" class="tab-content">
            <div class="dataset-selector">
                <label>Dataset:</label>
                <select id="dataset-select" onchange="loadNextExample()">
                    <option value="">Any</option>
                </select>
                <button class="btn btn-primary" onclick="loadNextExample()">Next Example</button>
            </div>

            <div class="instructions">
                <strong>Instructions:</strong>
                1. Click a label below to select it (or press <strong>1-9</strong>).
                2. Click tokens or use <strong>j/k</strong> to navigate and <strong>Space</strong> to toggle.
                3. <em>Connected tokens</em> (with a dash) are WordPiece subwords.
                4. Press <strong>Enter</strong> to save, <strong>Esc</strong> to skip, <strong>?</strong> for all shortcuts.
            </div>

            <div id="message-area"></div>

            <div id="example-area" class="card">
                <div class="loading">Loading example...</div>
            </div>

            <!-- Span Labels Section -->
            <div class="card labels-section">
                <div class="labels-header">
                    <h3>Span Labels</h3>
                    <button class="btn btn-secondary" onclick="addNewLabel()">+ New Label</button>
                </div>
                <div class="labels-grid" id="labels-grid"></div>
                <div class="legend" id="legend"></div>
            </div>

            <!-- Complexity Scores Section -->
            <div class="card complexity-section">
                <h3 style="margin-bottom: 15px;">Complexity Scores (0-10)</h3>
                <div class="complexity-grid" id="complexity-grid"></div>
            </div>

            <!-- Difficulty Justification Spans (shown when any complexity > 5) -->
            <div id="difficulty-justifications" class="card difficulty-justifications-section hidden">
                <h3 style="margin-bottom: 10px;">ðŸ“ Justify High Scores</h3>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">
                    For dimensions rated &gt;5, click to select, then mark tokens that justify that rating.
                </p>
                <div id="difficulty-justification-list" class="difficulty-justification-grid"></div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <div>
                    <button class="btn btn-warning" onclick="skipExample()">Skip <span style="opacity: 0.6; font-size: 0.8em;">(Esc)</span></button>
                    <button class="btn" style="background: #e63946; color: white;" onclick="showFlagModal()">ðŸš© Flag</button>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="clearSelections()">Clear All <span style="opacity: 0.6; font-size: 0.8em;">(c)</span></button>
                    <button class="btn btn-success" onclick="saveAndNext()">Save & Next <span style="opacity: 0.6; font-size: 0.8em;">(Enter)</span></button>
                </div>
            </div>
        </div>

        <!-- Flag Modal -->
        <div id="flag-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="card" style="max-width: 500px; margin: 20px;">
                <h3 style="margin-bottom: 15px;">ðŸš© Flag Example for Review</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">What's unusual about this example?</p>
                <textarea id="flag-reason" style="width: 100%; min-height: 100px; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee; resize: vertical;" placeholder="e.g., Ambiguous wording, unclear relationship, possible labeling error..."></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeFlagModal()">Cancel</button>
                    <button class="btn" style="background: #e63946; color: white;" onclick="submitFlag()">Submit Flag</button>
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content hidden">
            <!-- Personal Stats Card -->
            <div id="personal-stats-card" class="personal-stats-card hidden">
                <h3>ðŸ† Your Progress</h3>
                <div class="personal-stats-grid" id="personal-stats-grid">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Labeling Statistics</h3>
                <div id="stats-content" class="stats-grid">
                    <div class="loading">Loading stats...</div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="card leaderboard-section">
                <h3>ðŸ… Annotator Leaderboard</h3>
                <div id="leaderboard-content">
                    <div class="loading">Loading leaderboard...</div>
                </div>
            </div>
        </div>

        <!-- Lookup Tab -->
        <div id="lookup-tab" class="tab-content hidden">
            <div class="card">
                <h3 style="margin-bottom: 15px;">Lookup Example</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="lookup-dataset" placeholder="Dataset (e.g., snli)"
                           style="flex: 1; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                    <input type="text" id="lookup-id" placeholder="Example ID"
                           style="flex: 2; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                    <button class="btn btn-primary" onclick="lookupExample()">Lookup</button>
                </div>
                <div id="lookup-result"></div>
            </div>
        </div>

        <!-- Admin Dashboard Tab (Admin Only) -->
        <div id="admin-tab" class="tab-content hidden">
            <div class="admin-dashboard">
                <!-- Dashboard Header with Filters -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0;">ðŸ“Š Admin Dashboard</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="admin-dataset-filter" onchange="loadAdminDashboard()" style="padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                                <option value="">All Datasets</option>
                            </select>
                            <select id="admin-days-filter" onchange="loadAdminDashboard()" style="padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadAdminDashboard()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                </div>

                <!-- Overview Cards -->
                <div id="admin-overview" class="admin-overview-grid">
                    <div class="loading">Loading dashboard...</div>
                </div>

                <!-- Activity Chart -->
                <div class="card" style="margin-top: 20px;">
                    <h3>ðŸ“ˆ Annotation Activity</h3>
                    <div id="admin-activity-chart" style="height: 200px; display: flex; align-items: flex-end; gap: 2px; padding: 10px 0;">
                        <div class="loading">Loading activity...</div>
                    </div>
                </div>

                <!-- Two-column layout for tables -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Dataset Breakdown -->
                    <div class="card">
                        <h3>ðŸ“ Dataset Progress</h3>
                        <div id="admin-datasets-table">
                            <div class="loading">Loading datasets...</div>
                        </div>
                    </div>

                    <!-- Quality Indicators -->
                    <div class="card">
                        <h3>âš ï¸ Quality Indicators</h3>
                        <div id="admin-quality-indicators">
                            <div class="loading">Loading quality data...</div>
                        </div>
                    </div>
                </div>

                <!-- Annotator Table -->
                <div class="card" style="margin-top: 20px;">
                    <h3>ðŸ‘¥ Annotator Breakdown</h3>
                    <div id="admin-annotators-table" style="overflow-x: auto;">
                        <div class="loading">Loading annotators...</div>
                    </div>
                </div>

                <!-- Disagreement Hotspots -->
                <div class="card" style="margin-top: 20px;">
                    <h3>ðŸ”¥ Disagreement Hotspots</h3>
                    <p style="color: #888; font-size: 0.9em;">Examples with low agreement scores that may need review</p>
                    <div id="admin-hotspots-table">
                        <div class="loading">Loading hotspots...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Review Tab (Admin Only) -->
        <div id="quality-review-tab" class="tab-content hidden">
            <div class="card">
                <h3 style="margin-bottom: 15px;">ðŸ” Quality Review</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Review individual annotator quality. Select a user to see their annotations compared against consensus.
                </p>

                <!-- User Selection -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="review-user-select" onchange="loadUserReview()" style="flex: 1; min-width: 200px; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                        <option value="">Select user to review...</option>
                    </select>
                    <select id="review-dataset-filter" onchange="loadUserAnnotations()" style="padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                        <option value="">All datasets</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 5px; color: var(--text-secondary);">
                        <input type="checkbox" id="review-disagreements-only" onchange="loadUserAnnotations()">
                        Disagreements only
                    </label>
                </div>

                <!-- User Stats Summary -->
                <div id="review-user-stats" class="hidden" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="stat-card">
                            <div class="stat-value" id="review-total-annotations">-</div>
                            <div class="stat-label">Total Annotations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="review-reliability">-</div>
                            <div class="stat-label">Reliability Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="review-calibration">-</div>
                            <div class="stat-label">Calibration Status</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="review-disagreements">-</div>
                            <div class="stat-label">Disagreements</div>
                        </div>
                    </div>
                </div>

                <!-- Annotations List -->
                <div id="review-annotations-list">
                    <p style="color: var(--text-secondary); text-align: center;">Select a user to begin review.</p>
                </div>

                <!-- Pagination -->
                <div id="review-pagination" class="hidden" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button class="btn btn-secondary" onclick="loadUserAnnotations(reviewCurrentOffset - 20)" id="review-prev-btn">â† Previous</button>
                    <span id="review-page-info" style="padding: 10px; color: var(--text-secondary);"></span>
                    <button class="btn btn-secondary" onclick="loadUserAnnotations(reviewCurrentOffset + 20)" id="review-next-btn">Next â†’</button>
                </div>
            </div>

            <!-- Annotation Detail Modal -->
            <div id="annotation-detail-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div class="card" style="max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Annotation Detail</h3>
                        <button class="btn btn-secondary" onclick="closeAnnotationDetail()">Ã—</button>
                    </div>
                    <div id="annotation-detail-content"></div>
                </div>
            </div>
        </div>

        <!-- Gold Examples Admin Tab -->
        <div id="gold-examples-tab" class="tab-content hidden">
            <div class="gold-examples-header">
                <h2>ðŸ“š Gold Examples</h2>
                <div>
                    <span id="gold-count">0</span> gold examples configured
                    (need <span id="gold-required">5</span> for training)
                </div>
            </div>

            <div class="card">
                <p style="margin-bottom: 15px;">Gold examples are used to train new annotators. Each example needs:</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Gold-standard complexity scores (the "correct" answers)</li>
                    <li>An explanation of why these are the correct scores</li>
                </ul>
                <p>To add a gold example, annotate any example in the Quality Review tab and click "Mark as Gold".</p>
            </div>

            <div id="gold-examples-list">
                <div class="loading">Loading gold examples...</div>
            </div>
        </div>

        <!-- Flagged Examples Tab (Admin Only) -->
        <div id="flagged-tab" class="tab-content hidden">
            <div class="card">
                <h3 style="margin-bottom: 15px;">ðŸš© Flagged Examples</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Review flagged examples - both auto-flagged (low agreement) and manually flagged by annotators.
                </p>

                <!-- Stats Summary -->
                <div id="flagged-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="flagged-total">-</div>
                        <div class="stat-label">Total Flagged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="flagged-pending">-</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="flagged-auto">-</div>
                        <div class="stat-label">Auto-flagged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="flagged-manual">-</div>
                        <div class="stat-label">Manual</div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="flagged-status-filter" onchange="loadFlaggedExamples()" style="padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                        <option value="">All statuses</option>
                        <option value="pending">Pending</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="resolved">Resolved</option>
                        <option value="excluded">Excluded</option>
                    </select>
                    <select id="flagged-source-filter" onchange="loadFlaggedExamples()" style="padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #eee;">
                        <option value="">All sources</option>
                        <option value="auto">Auto-flagged</option>
                        <option value="manual">Manual</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadFlaggedExamples()">ðŸ”„ Refresh</button>
                </div>

                <!-- Flagged List -->
                <div id="flagged-list">
                    <p style="color: var(--text-secondary); text-align: center;">Loading flagged examples...</p>
                </div>

                <!-- Pagination -->
                <div id="flagged-pagination" class="hidden" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button class="btn btn-secondary" onclick="loadFlaggedExamples(flaggedCurrentOffset - 50)" id="flagged-prev-btn">â† Previous</button>
                    <span id="flagged-page-info" style="padding: 10px; color: var(--text-secondary);"></span>
                    <button class="btn btn-secondary" onclick="loadFlaggedExamples(flaggedCurrentOffset + 50)" id="flagged-next-btn">Next â†’</button>
                </div>
            </div>

            <!-- Flag Detail Modal -->
            <div id="flag-detail-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div class="card" style="max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ðŸš© Flagged Example Detail</h3>
                        <button class="btn btn-secondary" onclick="closeFlagDetailModal()">Ã—</button>
                    </div>
                    <div id="flag-detail-content"></div>
                    <div id="flag-detail-actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================
        let currentExample = null;
        let activeLabel = null;
        let labels = [];
        let currentUser = null;
        let isAnonymousMode = false;

        // Leaderboard state
        let leaderboardData = [];
        let leaderboardSortColumn = 'labeled';
        let leaderboardSortDirection = 'desc';

        // Keyboard navigation state
        let focusedSource = 'premise';  // 'premise' or 'hypothesis'
        let focusedWordIndex = -1;       // -1 means no focus

        // Pre-defined labels with colors
        const presetLabels = [
            // Difficulty dimensions
            { name: 'reasoning', color: '#3b82f6', colorIndex: 0 },
            { name: 'creativity', color: '#8b5cf6', colorIndex: 1 },
            { name: 'domain_knowledge', color: '#06b6d4', colorIndex: 2 },
            { name: 'contextual', color: '#22c55e', colorIndex: 3 },
            { name: 'constraints', color: '#eab308', colorIndex: 4 },
            { name: 'ambiguity', color: '#f97316', colorIndex: 5 },
            // NLI labels
            { name: 'entailment', color: '#4ade80', colorIndex: 6 },
            { name: 'neutral', color: '#fbbf24', colorIndex: 7 },
            { name: 'contradiction', color: '#f87171', colorIndex: 8 },
        ];

        // Complexity dimensions
        const complexityDimensions = [
            { key: 'reasoning', label: 'Reasoning', description: 'Logical inference required' },
            { key: 'creativity', label: 'Creativity', description: 'Imaginative interpretation' },
            { key: 'domain_knowledge', label: 'Domain Knowledge', description: 'Specialized expertise' },
            { key: 'contextual', label: 'Contextual', description: 'Implicit context dependence' },
            { key: 'constraints', label: 'Constraints', description: 'Conditions to track' },
            { key: 'ambiguity', label: 'Ambiguity', description: 'Answer debatability' },
        ];

        // ============================================================================
        // Authentication
        // ============================================================================

        let allowAnonymousSubmissions = false;

        async function checkAuthStatus() {
            try {
                // First check if we're in anonymous mode
                const statusResp = await fetch('/api/auth/status');
                const status = await statusResp.json();
                isAnonymousMode = status.anonymous_mode;
                allowAnonymousSubmissions = status.allow_anonymous_submissions;

                if (isAnonymousMode) {
                    // Anonymous mode - no login needed
                    currentUser = { username: 'anonymous', display_name: 'Anonymous', is_anonymous: true };
                    hideAuthModal();
                    updateUserDisplay();
                    return true;
                }

                // Check if user is already logged in
                const meResp = await fetch('/api/me');
                const meData = await meResp.json();

                if (meData.authenticated === false) {
                    // Not logged in - show auth modal
                    showAuthModal();
                    return false;
                }

                // User is logged in
                currentUser = meData;
                hideAuthModal();
                updateUserDisplay();
                return true;
            } catch (e) {
                console.error('Auth check failed:', e);
                showAuthModal();
                return false;
            }
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            if (isAnonymousMode) {
                document.getElementById('anonymous-note').classList.remove('hidden');
            }
            // Show dismiss option if anonymous submissions allowed
            if (allowAnonymousSubmissions && !isAnonymousMode) {
                document.getElementById('dismiss-note').classList.remove('hidden');
                document.getElementById('auth-modal-close').classList.remove('hidden');
            }
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function handleAuthOverlayClick(event) {
            // Only dismiss if clicking the overlay itself (not the modal content)
            // and anonymous submissions are allowed
            if (event.target.id === 'auth-modal' && allowAnonymousSubmissions) {
                dismissAuthModal();
            }
        }

        function dismissAuthModal() {
            if (allowAnonymousSubmissions || isAnonymousMode) {
                currentUser = { username: 'anonymous', display_name: 'Anonymous', is_anonymous: true };
                hideAuthModal();
                updateUserDisplay();
                // Load initial data
                loadNextExample();
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('#auth-modal .modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#auth-modal .modal-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
            
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
            
            // Clear errors
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    errorEl.textContent = err.detail || 'Login failed';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success - reload auth state
                await checkAuthStatus();
                initializeApp();
            } catch (e) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('register-username').value;
            const display_name = document.getElementById('register-display').value || null;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');

            try {
                const resp = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, display_name })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    errorEl.textContent = err.detail || 'Registration failed';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success - reload auth state
                await checkAuthStatus();
                initializeApp();
            } catch (e) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                showAuthModal();
                updateUserDisplay();
            } catch (e) {
                console.error('Logout failed:', e);
            }
        }

        function updateUserDisplay() {
            const userInfo = document.getElementById('user-info');
            const usernameDisplay = document.getElementById('username-display');

            if (currentUser) {
                usernameDisplay.textContent = currentUser.display_name || currentUser.username;
                userInfo.classList.remove('hidden');
                
                // Hide logout button in anonymous mode
                const logoutBtn = userInfo.querySelector('.logout-btn');
                if (currentUser.is_anonymous) {
                    logoutBtn.classList.add('hidden');
                } else {
                    logoutBtn.classList.remove('hidden');
                }
            } else {
                userInfo.classList.add('hidden');
            }
        }

        // ============================================================================
        // Authenticated Fetch (handles 401s)
        // ============================================================================

        async function authenticatedFetch(url, options = {}) {
            const resp = await fetch(url, options);
            
            if (resp.status === 401) {
                // Session expired or not authenticated
                currentUser = null;
                showAuthModal();
                updateUserDisplay();
                throw new Error('Session expired. Please log in again.');
            }
            
            return resp;
        }

        // ============================================================================
        // Help Modal
        // ============================================================================

        function showHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function hideHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        function toggleHelpModal() {
            const modal = document.getElementById('help-modal');
            if (modal.classList.contains('hidden')) {
                showHelpModal();
            } else {
                hideHelpModal();
            }
        }

        function switchHelpTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#help-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.help-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`help-${tabName}`).classList.add('active');
        }

        // ============================================================================
        // Keyboard Navigation
        // ============================================================================

        function initKeyboardNavigation() {
            document.addEventListener('keydown', handleKeyDown);
        }

        function handleKeyDown(e) {
            // Don't handle keys when typing in inputs
            if (e.target.matches('input, textarea, select')) {
                return;
            }

            // Don't handle if auth modal is shown
            if (!document.getElementById('auth-modal').classList.contains('hidden')) {
                return;
            }

            // Help modal toggle (? key)
            if (e.key === '?') {
                e.preventDefault();
                toggleHelpModal();
                return;
            }

            // Close help modal with Escape
            if (e.key === 'Escape') {
                if (!document.getElementById('help-modal').classList.contains('hidden')) {
                    e.preventDefault();
                    hideHelpModal();
                    return;
                }
            }

            // Only process labeler shortcuts when on labeler tab
            if (document.getElementById('labeler-tab').classList.contains('hidden')) {
                return;
            }

            // Help modal is open - don't process other shortcuts
            if (!document.getElementById('help-modal').classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    hideHelpModal();
                }
                return;
            }

            // Shift+1-6: Focus difficulty sliders
            if (e.shiftKey && e.key >= '1' && e.key <= '6') {
                e.preventDefault();
                focusSlider(parseInt(e.key) - 1);
                return;
            }

            // +/- or =/_ : Adjust focused slider (= is unshifted +, - works both ways)
            if (focusedSliderIndex >= 0) {
                if (e.key === '+' || e.key === '=' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    adjustFocusedSlider(1);
                    return;
                }
                if (e.key === '-' || e.key === '_' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    adjustFocusedSlider(-1);
                    return;
                }
                // Direct number input for slider (0-9 sets value directly when slider focused)
                if (!e.shiftKey && e.key >= '0' && e.key <= '9') {
                    e.preventDefault();
                    const dim = complexityDimensions[focusedSliderIndex];
                    syncComplexity(dim.key, parseInt(e.key), 'keyboard');
                    return;
                }
                // Escape clears slider focus
                if (e.key === 'Escape') {
                    e.preventDefault();
                    clearSliderFocus();
                    return;
                }
            }

            switch (e.key) {
                // Navigation: j/k or arrows
                case 'j':
                case 'ArrowRight':
                    e.preventDefault();
                    navigateWord(1);
                    break;
                case 'k':
                case 'ArrowLeft':
                    e.preventDefault();
                    navigateWord(-1);
                    break;

                // Tab: switch premise/hypothesis
                case 'Tab':
                    e.preventDefault();
                    switchFocusSource();
                    break;

                // Home/End: first/last word
                case 'Home':
                    e.preventDefault();
                    focusFirstWord();
                    break;
                case 'End':
                    e.preventDefault();
                    focusLastWord();
                    break;

                // Space: toggle active label on focused word
                case ' ':
                    e.preventDefault();
                    toggleLabelOnFocusedWord();
                    break;

                // Number keys 1-9: toggle specific label (only when no slider focused)
                case '1': case '2': case '3': case '4': case '5':
                case '6': case '7': case '8': case '9':
                    e.preventDefault();
                    toggleLabelByNumber(parseInt(e.key) - 1);
                    break;

                // Enter: save and next
                case 'Enter':
                    e.preventDefault();
                    saveAndNext();
                    break;

                // Escape: skip
                case 'Escape':
                    e.preventDefault();
                    skipExample();
                    break;

                // n: load next example
                case 'n':
                    e.preventDefault();
                    loadNextExample();
                    break;

                // c: clear all selections
                case 'c':
                    e.preventDefault();
                    clearSelections();
                    break;
            }
        }

        function getWordCount(source) {
            if (!currentExample) return 0;
            return source === 'premise' 
                ? currentExample.premise_words.length 
                : currentExample.hypothesis_words.length;
        }

        function navigateWord(delta) {
            if (!currentExample) return;

            const wordCount = getWordCount(focusedSource);
            if (wordCount === 0) return;

            if (focusedWordIndex === -1) {
                // No current focus - start at beginning or end
                focusedWordIndex = delta > 0 ? 0 : wordCount - 1;
            } else {
                focusedWordIndex += delta;
                // Wrap around
                if (focusedWordIndex < 0) focusedWordIndex = wordCount - 1;
                if (focusedWordIndex >= wordCount) focusedWordIndex = 0;
            }

            updateFocusDisplay();
        }

        function switchFocusSource() {
            focusedSource = focusedSource === 'premise' ? 'hypothesis' : 'premise';
            
            // Clamp index to new source's word count
            const wordCount = getWordCount(focusedSource);
            if (focusedWordIndex >= wordCount) {
                focusedWordIndex = wordCount - 1;
            }
            if (focusedWordIndex < 0 && wordCount > 0) {
                focusedWordIndex = 0;
            }

            updateFocusDisplay();
        }

        function focusFirstWord() {
            if (!currentExample) return;
            focusedWordIndex = 0;
            updateFocusDisplay();
        }

        function focusLastWord() {
            if (!currentExample) return;
            const wordCount = getWordCount(focusedSource);
            focusedWordIndex = wordCount - 1;
            updateFocusDisplay();
        }

        function toggleLabelOnFocusedWord() {
            if (focusedWordIndex === -1 || activeLabel === null) {
                if (activeLabel === null) {
                    showMessage('Select a label first (1-9 keys)', 'error');
                }
                return;
            }
            toggleWord(focusedSource, focusedWordIndex);
        }

        function toggleLabelByNumber(labelIndex) {
            if (labelIndex >= labels.length) return;

            // Select this label as active
            activeLabel = labelIndex;
            renderLabels();

            // If we have a focused word, toggle it immediately
            if (focusedWordIndex !== -1) {
                toggleWord(focusedSource, focusedWordIndex);
            }

            updateWordHighlights();
        }

        function updateFocusDisplay() {
            // Remove old focus
            document.querySelectorAll('.word.keyboard-focus').forEach(el => {
                el.classList.remove('keyboard-focus');
            });
            document.querySelectorAll('.text-section.active-section').forEach(el => {
                el.classList.remove('active-section');
            });

            if (focusedWordIndex === -1 || !currentExample) return;

            // Add focus to current word
            const wordEl = document.querySelector(
                `.word[data-source="${focusedSource}"][data-index="${focusedWordIndex}"]`
            );
            if (wordEl) {
                wordEl.classList.add('keyboard-focus');
                // Scroll into view if needed
                wordEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Highlight the active section
            const sectionEl = document.getElementById(`${focusedSource}-text`)?.closest('.text-section');
            if (sectionEl) {
                sectionEl.classList.add('active-section');
            }
        }

        function resetFocus() {
            focusedWordIndex = -1;
            focusedSource = 'premise';
            updateFocusDisplay();
        }

        // ============================================================================
        // Initialization
        // ============================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth first
            const isAuthenticated = await checkAuthStatus();
            
            if (isAuthenticated) {
                initializeApp();
            }

            // Always init keyboard navigation
            initKeyboardNavigation();
        });

        async function initializeApp() {
            await Promise.all([
                loadDatasets(),
                loadTokenizerInfo()
            ]);
            initLabels();
            initComplexityInputs();
            // Check if user needs training before loading examples
            if (typeof checkTrainingStatus === 'function') {
                await checkTrainingStatus();
            }
            loadNextExample();
        }

        async function loadTokenizerInfo() {
            try {
                const resp = await fetch('/api/tokenizer/info');
                const info = await resp.json();
                const badge = document.getElementById('tokenizer-badge');
                // Show just the model name, not the full path
                const shortName = info.model.split('/').pop();
                badge.textContent = shortName;
                badge.title = `Tokenizer: ${info.model} (${info.type}, vocab: ${info.vocab_size.toLocaleString()})`;
            } catch (e) {
                console.error('Failed to load tokenizer info:', e);
                document.getElementById('tokenizer-badge').textContent = 'tokenizer';
            }
        }

        async function loadDatasets() {
            try {
                const resp = await fetch('/api/datasets');
                const data = await resp.json();
                const select = document.getElementById('dataset-select');
                data.datasets.forEach(ds => {
                    const option = document.createElement('option');
                    option.value = ds;
                    option.textContent = ds;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load datasets:', e);
            }
        }

        function initLabels() {
            labels = presetLabels.map(p => ({
                ...p,
                spans: { premise: new Set(), hypothesis: new Set() }
            }));
            renderLabels();
            renderLegend();
        }

        let focusedSliderIndex = -1;  // Track which slider has keyboard focus

        function initComplexityInputs() {
            const grid = document.getElementById('complexity-grid');
            grid.innerHTML = complexityDimensions.map((dim, idx) => `
                <div class="complexity-item" id="complexity-item-${dim.key}">
                    <div class="complexity-label">
                        ${dim.label}
                        <span class="slider-key-hint">Shift+${idx + 1}</span>
                    </div>
                    <div class="complexity-input">
                        <input type="range" id="complexity-range-${dim.key}"
                               min="0" max="10" value="0"
                               oninput="syncComplexity('${dim.key}', this.value, 'range')">
                        <input type="number" id="complexity-num-${dim.key}"
                               min="0" max="10" value="0"
                               oninput="syncComplexity('${dim.key}', this.value, 'num')">
                    </div>
                </div>
            `).join('');
        }

        function focusSlider(index) {
            if (index < 0 || index >= complexityDimensions.length) return;
            focusedSliderIndex = index;
            const dim = complexityDimensions[index];
            const rangeInput = document.getElementById(`complexity-range-${dim.key}`);
            if (rangeInput) {
                rangeInput.focus();
                // Highlight the slider item
                document.querySelectorAll('.complexity-item').forEach(el => el.classList.remove('focused'));
                document.getElementById(`complexity-item-${dim.key}`)?.classList.add('focused');
            }
        }

        function adjustFocusedSlider(delta) {
            if (focusedSliderIndex < 0 || focusedSliderIndex >= complexityDimensions.length) return;
            const dim = complexityDimensions[focusedSliderIndex];
            const numInput = document.getElementById(`complexity-num-${dim.key}`);
            if (numInput) {
                const newValue = Math.max(0, Math.min(10, parseInt(numInput.value) + delta));
                syncComplexity(dim.key, newValue, 'keyboard');
            }
        }

        function clearSliderFocus() {
            focusedSliderIndex = -1;
            document.querySelectorAll('.complexity-item').forEach(el => el.classList.remove('focused'));
        }

        function syncComplexity(key, value, source) {
            // Clamp value to valid range
            value = Math.max(0, Math.min(10, parseInt(value) || 0));

            const rangeInput = document.getElementById(`complexity-range-${key}`);
            const numInput = document.getElementById(`complexity-num-${key}`);

            if (source === 'range') {
                numInput.value = value;
            } else {
                rangeInput.value = value;
            }

            // Show/hide justification span prompt when value > 5
            updateDifficultyJustification(key, value);
        }

        // ============================================================================
        // Conditional Difficulty Span Justifications
        // ============================================================================

        const DIFFICULTY_THRESHOLD = 5;  // Show justification prompt when slider > this value
        const difficultyJustifications = new Map();  // key -> { active: bool, spans: { premise: Set, hypothesis: Set } }

        const difficultyLabels = {
            reasoning: { color: '#3b82f6', prompt: 'Mark tokens requiring logical inference' },
            creativity: { color: '#8b5cf6', prompt: 'Mark tokens needing imaginative interpretation' },
            domain_knowledge: { color: '#06b6d4', prompt: 'Mark tokens requiring specialized knowledge' },
            contextual: { color: '#22c55e', prompt: 'Mark tokens depending on implicit context' },
            constraints: { color: '#eab308', prompt: 'Mark tokens representing conditions to track' },
            ambiguity: { color: '#f97316', prompt: 'Mark tokens that are ambiguous or debatable' }
        };

        function updateDifficultyJustification(key, value) {
            const container = document.getElementById('difficulty-justifications');
            if (!container) return;

            if (value > DIFFICULTY_THRESHOLD) {
                // Show justification prompt
                if (!difficultyJustifications.has(key)) {
                    difficultyJustifications.set(key, {
                        active: false,
                        spans: { premise: new Set(), hypothesis: new Set() }
                    });
                }
                renderDifficultyJustifications();
            } else {
                // Hide justification prompt
                difficultyJustifications.delete(key);
                renderDifficultyJustifications();
            }
        }

        function renderDifficultyJustifications() {
            const container = document.getElementById('difficulty-justifications');
            if (!container) return;

            if (difficultyJustifications.size === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            const list = document.getElementById('difficulty-justification-list');

            list.innerHTML = Array.from(difficultyJustifications.entries()).map(([key, data]) => {
                const label = difficultyLabels[key];
                const displayName = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const spanCount = data.spans.premise.size + data.spans.hypothesis.size;

                return `
                    <div class="difficulty-justification-item ${data.active ? 'active' : ''}"
                         onclick="selectDifficultyJustification('${key}')"
                         data-key="${key}">
                        <div class="justification-color" style="background: ${label.color}"></div>
                        <div class="justification-info">
                            <div class="justification-name">${displayName}</div>
                            <div class="justification-prompt">${label.prompt}</div>
                        </div>
                        <div class="justification-count">${spanCount}</div>
                    </div>
                `;
            }).join('');
        }

        function selectDifficultyJustification(key) {
            // Deactivate all other justifications and regular labels
            difficultyJustifications.forEach((data, k) => {
                data.active = (k === key) ? !data.active : false;
            });
            activeLabel = null;  // Deselect regular labels
            renderLabels();
            renderDifficultyJustifications();
            updateWordHighlights();
        }

        function getActiveDifficultyJustification() {
            for (const [key, data] of difficultyJustifications) {
                if (data.active) return key;
            }
            return null;
        }

        function toggleDifficultyJustificationWord(source, index) {
            const activeKey = getActiveDifficultyJustification();
            if (!activeKey) return false;

            const data = difficultyJustifications.get(activeKey);
            if (!data) return false;

            if (data.spans[source].has(index)) {
                data.spans[source].delete(index);
            } else {
                data.spans[source].add(index);
            }

            renderDifficultyJustifications();
            updateWordHighlights();
            return true;
        }

        // ============================================================================
        // Labels
        // ============================================================================

        function renderLabels() {
            const grid = document.getElementById('labels-grid');
            grid.innerHTML = labels.map((label, idx) => {
                const totalSpans = label.spans.premise.size + label.spans.hypothesis.size;
                const isActive = activeLabel === idx;
                const keyHint = idx < 9 ? idx + 1 : '';
                return `
                    <div class="label-item ${isActive ? 'active' : ''}"
                         onclick="selectLabel(${idx})"
                         data-label-idx="${idx}">
                        <div class="label-color" style="background: ${label.color}"></div>
                        <div class="label-name">
                            <input type="text" value="${label.name}"
                                   onclick="event.stopPropagation()"
                                   onchange="updateLabelName(${idx}, this.value)">
                        </div>
                        ${keyHint ? `<span class="label-key">${keyHint}</span>` : ''}
                        ${totalSpans > 0 ? `<span class="label-count">${totalSpans}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = labels.map(l => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: ${l.color}"></div>
                    <span>${l.name}</span>
                </div>
            `).join('');
        }

        function selectLabel(idx) {
            activeLabel = activeLabel === idx ? null : idx;
            // Deselect any active difficulty justification when selecting a regular label
            difficultyJustifications.forEach((data, key) => {
                data.active = false;
            });
            renderDifficultyJustifications();
            renderLabels();
            updateWordHighlights();
        }

        function updateLabelName(idx, newName) {
            labels[idx].name = newName;
            renderLegend();
        }

        function addNewLabel() {
            const colorIndex = labels.length % 9;
            const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#22c55e', '#eab308', '#f97316', '#4ade80', '#fbbf24', '#f87171'];
            labels.push({
                name: `custom_${labels.length + 1}`,
                color: colors[colorIndex],
                colorIndex: colorIndex,
                spans: { premise: new Set(), hypothesis: new Set() }
            });
            renderLabels();
            renderLegend();
        }

        // ============================================================================
        // Examples
        // ============================================================================

        async function loadNextExample() {
            const dataset = document.getElementById('dataset-select').value;
            const area = document.getElementById('example-area');
            area.innerHTML = '<div class="loading">Loading example...</div>';

            try {
                const url = dataset ? `/api/next?dataset=${dataset}` : '/api/next';
                const resp = await authenticatedFetch(url);
                const data = await resp.json();

                // Handle 404 (no more examples)
                if (!resp.ok) {
                    if (resp.status === 404) {
                        area.innerHTML = `<div class="message info">${data.detail || 'No more examples to annotate. All done!'}</div>`;
                    } else {
                        area.innerHTML = `<div class="message error">${data.detail || 'Error loading example'}</div>`;
                    }
                    currentExample = null;
                    return;
                }

                if (data.complete) {
                    area.innerHTML = `<div class="message success">${data.message}</div>`;
                    currentExample = null;
                    return;
                }

                currentExample = data;
                resetLabelsForNewExample();
                renderExample();
                resetFocus();
            } catch (e) {
                area.innerHTML = `<div class="message error">Error loading example: ${e.message}</div>`;
            }
        }

        function resetLabelsForNewExample() {
            labels.forEach(label => {
                label.spans = { premise: new Set(), hypothesis: new Set() };
            });
            activeLabel = null;
            renderLabels();

            // Reset complexity scores to 0 (default on 0-10 scale)
            complexityDimensions.forEach(dim => {
                const rangeInput = document.getElementById(`complexity-range-${dim.key}`);
                const numInput = document.getElementById(`complexity-num-${dim.key}`);
                if (rangeInput) rangeInput.value = 0;
                if (numInput) numInput.value = 0;
            });

            // Clear difficulty justifications
            difficultyJustifications.clear();
            renderDifficultyJustifications();
        }

        function renderExample() {
            if (!currentExample) return;

            const area = document.getElementById('example-area');
            const goldLabelClass = currentExample.gold_label_text || 'neutral';

            area.innerHTML = `
                <div class="example-header">
                    <span class="example-id">${currentExample.id}</span>
                    <span class="gold-label ${goldLabelClass}">${currentExample.gold_label_text || 'unknown'}</span>
                </div>
                <div class="text-section" id="premise-section">
                    <div class="text-label">Premise</div>
                    <div class="text-content" id="premise-text">
                        ${renderWords(currentExample.premise_words, 'premise')}
                    </div>
                </div>
                <div class="text-section" id="hypothesis-section">
                    <div class="text-label">Hypothesis</div>
                    <div class="text-content" id="hypothesis-text">
                        ${renderWords(currentExample.hypothesis_words, 'hypothesis')}
                    </div>
                </div>
                <div class="auto-spans-section" id="auto-spans-container">
                    <div class="auto-spans-header">Auto-detected patterns</div>
                    <div id="auto-spans-content" class="auto-spans-list">
                        <span class="auto-spans-empty">Loading...</span>
                    </div>
                </div>
            `;

            // Load auto-spans for this example
            loadAutoSpans(currentExample.id);

            // Load existing labels if any
            if (currentExample.existing_labels && currentExample.existing_labels.length > 0) {
                loadExistingLabels(currentExample.existing_labels);
            }

            // Load existing scores if any
            if (currentExample.existing_scores) {
                Object.entries(currentExample.existing_scores).forEach(([key, value]) => {
                    if (value !== null) {
                        const rangeInput = document.getElementById(`complexity-range-${key}`);
                        const numInput = document.getElementById(`complexity-num-${key}`);
                        if (rangeInput) rangeInput.value = value;
                        if (numInput) numInput.value = value;
                    }
                });
            }
        }

        function renderWords(words, source) {
            return words.map(w => {
                const isSubword = w.is_subword || false;
                const containerClass = isSubword ? 'word-container subword' : 'word-container';
                const wordClass = isSubword ? 'word subword' : 'word';
                const title = w.token ? `Token: ${w.token}` : '';
                // Clean up tokenizer artifacts (Ä  = leading space in GPT-2/RoBERTa tokenizers)
                const displayText = (w.text || '').replace(/Ä /g, '').replace(/â–/g, '') || w.text;

                return `
                    <span class="${containerClass}">
                        <span class="${wordClass}"
                              data-source="${source}"
                              data-index="${w.index}"
                              data-char-start="${w.char_start}"
                              data-char-end="${w.char_end}"
                              data-is-subword="${isSubword}"
                              title="${title}"
                              onclick="handleWordClick('${source}', ${w.index})">${displayText}</span>
                        <div class="label-dots" data-source="${source}" data-index="${w.index}"></div>
                    </span>
                `;
            }).join('');
        }

        // ============================================================================
        // Auto-spans Display (Tier 0/1 read-only labels)
        // ============================================================================

        async function loadAutoSpans(exampleId) {
            const container = document.getElementById('auto-spans-content');
            if (!container) return;

            try {
                const resp = await authenticatedFetch(`/api/auto-spans/${exampleId}`);
                if (!resp.ok) {
                    container.innerHTML = '<span class="auto-spans-empty">Unable to load auto-spans</span>';
                    return;
                }

                const data = await resp.json();
                renderAutoSpans(data.auto_spans);
            } catch (e) {
                console.error('Failed to load auto-spans:', e);
                container.innerHTML = '<span class="auto-spans-empty">Error loading auto-spans</span>';
            }
        }

        function renderAutoSpans(autoSpans) {
            const container = document.getElementById('auto-spans-content');
            if (!container || !autoSpans) return;

            const tags = [];

            // Human-readable label names
            const labelNames = {
                'aligned_tokens': 'Aligned',
                'premise_only': 'Premise only',
                'hypothesis_only': 'Hypothesis only',
                'negation': 'Negation',
                'quantifier': 'Quantifier',
                'modal': 'Modal',
                'conditional': 'Conditional',
                'temporal': 'Temporal',
                'causal': 'Causal',
                'hypernym': 'Hypernym',
                'hyponym': 'Hyponym',
                'synonym': 'Synonym',
                'antonym': 'Antonym'
            };

            // Process Tier 0 labels
            if (autoSpans.tier0) {
                Object.entries(autoSpans.tier0).forEach(([label, sources]) => {
                    const premiseIndices = sources.premise || [];
                    const hypothesisIndices = sources.hypothesis || [];
                    const allIndices = [...premiseIndices, ...hypothesisIndices];

                    if (allIndices.length > 0) {
                        const displayName = labelNames[label] || label.replace(/_/g, ' ');
                        const tokenText = getTokenText(premiseIndices, hypothesisIndices);
                        tags.push(`
                            <span class="auto-span-tag tier0" title="${label}: ${tokenText}">
                                <span class="label-name">${displayName}</span>
                                <span class="token-list">${tokenText}</span>
                            </span>
                        `);
                    }
                });
            }

            // Process Tier 1 labels (WordNet-based, future)
            if (autoSpans.tier1) {
                Object.entries(autoSpans.tier1).forEach(([label, sources]) => {
                    const premiseIndices = sources.premise || [];
                    const hypothesisIndices = sources.hypothesis || [];
                    const allIndices = [...premiseIndices, ...hypothesisIndices];

                    if (allIndices.length > 0) {
                        const displayName = labelNames[label] || label.replace(/_/g, ' ');
                        const tokenText = getTokenText(premiseIndices, hypothesisIndices);
                        tags.push(`
                            <span class="auto-span-tag tier1" title="${label}: ${tokenText}">
                                <span class="label-name">${displayName}</span>
                                <span class="token-list">${tokenText}</span>
                            </span>
                        `);
                    }
                });
            }

            if (tags.length === 0) {
                container.innerHTML = '<span class="auto-spans-empty">No patterns detected</span>';
            } else {
                container.innerHTML = tags.join('');
            }
        }

        function getTokenText(premiseIndices, hypothesisIndices) {
            const parts = [];
            if (premiseIndices.length > 0 && currentExample) {
                const tokens = premiseIndices
                    .map(i => currentExample.premise_words[i]?.text || '')
                    .filter(t => t)
                    .map(t => t.replace(/Ä |â–/g, '').trim())
                    .filter(t => t);
                if (tokens.length > 0) {
                    parts.push(`P: ${tokens.slice(0, 3).join(', ')}${tokens.length > 3 ? '...' : ''}`);
                }
            }
            if (hypothesisIndices.length > 0 && currentExample) {
                const tokens = hypothesisIndices
                    .map(i => currentExample.hypothesis_words[i]?.text || '')
                    .filter(t => t)
                    .map(t => t.replace(/Ä |â–/g, '').trim())
                    .filter(t => t);
                if (tokens.length > 0) {
                    parts.push(`H: ${tokens.slice(0, 3).join(', ')}${tokens.length > 3 ? '...' : ''}`);
                }
            }
            return parts.join(' | ') || 'tokens';
        }

        function handleWordClick(source, index) {
            // Update keyboard focus to clicked word
            focusedSource = source;
            focusedWordIndex = index;
            updateFocusDisplay();

            // Toggle label
            toggleWord(source, index);
        }

        function loadExistingLabels(existingLabels) {
            existingLabels.forEach(existing => {
                let labelIdx = labels.findIndex(l => l.name === existing.label_name);
                if (labelIdx === -1) {
                    const colorIndex = labels.length % 9;
                    const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#22c55e', '#eab308', '#f97316', '#4ade80', '#fbbf24', '#f87171'];
                    labels.push({
                        name: existing.label_name,
                        color: existing.label_color || colors[colorIndex],
                        colorIndex: colorIndex,
                        spans: { premise: new Set(), hypothesis: new Set() }
                    });
                    labelIdx = labels.length - 1;
                }

                existing.spans.forEach(span => {
                    labels[labelIdx].spans[span.source].add(span.word_index);
                });
            });

            renderLabels();
            renderLegend();
            updateWordHighlights();
        }

        function toggleWord(source, index) {
            // Check for active difficulty justification first
            if (toggleDifficultyJustificationWord(source, index)) {
                return;  // Handled by difficulty justification
            }

            if (activeLabel === null) {
                showMessage('Select a label first (click or press 1-9)', 'error');
                return;
            }

            const spans = labels[activeLabel].spans[source];
            if (spans.has(index)) {
                spans.delete(index);
            } else {
                spans.add(index);
            }

            renderLabels();
            updateWordHighlights();
        }

        function updateWordHighlights() {
            // Clear all word styles and dots
            document.querySelectorAll('.word').forEach(el => {
                // Preserve subword and keyboard-focus classes if present
                const isSubword = el.dataset.isSubword === 'true';
                const hasFocus = el.classList.contains('keyboard-focus');
                el.className = isSubword ? 'word subword' : 'word';
                if (hasFocus) el.classList.add('keyboard-focus');
            });
            document.querySelectorAll('.label-dots').forEach(el => {
                el.innerHTML = '';
            });

            // Build a map of word -> labels for each source
            const wordLabels = { premise: {}, hypothesis: {} };

            labels.forEach((label, labelIdx) => {
                ['premise', 'hypothesis'].forEach(source => {
                    label.spans[source].forEach(wordIdx => {
                        if (!wordLabels[source][wordIdx]) {
                            wordLabels[source][wordIdx] = [];
                        }
                        wordLabels[source][wordIdx].push({
                            labelIdx,
                            color: label.color,
                            colorIndex: label.colorIndex
                        });
                    });
                });
            });

            // Apply highlights and dots
            ['premise', 'hypothesis'].forEach(source => {
                Object.entries(wordLabels[source]).forEach(([wordIdx, labelList]) => {
                    const wordEl = document.querySelector(
                        `.word[data-source="${source}"][data-index="${wordIdx}"]`
                    );
                    const dotsEl = document.querySelector(
                        `.label-dots[data-source="${source}"][data-index="${wordIdx}"]`
                    );

                    if (wordEl && dotsEl) {
                        // Check if active label is in this word's labels
                        const hasActiveLabel = labelList.some(l => l.labelIdx === activeLabel);

                        if (hasActiveLabel && activeLabel !== null) {
                            // Style word with active label's color
                            const activeLabelInfo = labelList.find(l => l.labelIdx === activeLabel);
                            wordEl.classList.add('has-active-label', `color-${activeLabelInfo.colorIndex}`);
                        }

                        // Create dots for all labels, with active label's dot larger
                        // Sort so active label's dot is first (most visible)
                        const sortedLabels = [...labelList].sort((a, b) => {
                            if (a.labelIdx === activeLabel) return -1;
                            if (b.labelIdx === activeLabel) return 1;
                            return 0;
                        });

                        dotsEl.innerHTML = sortedLabels.map(l => `
                            <div class="label-dot ${l.labelIdx === activeLabel ? 'active-label' : ''}"
                                 style="background: ${l.color}; color: ${l.color};"
                                 title="${labels[l.labelIdx].name}"></div>
                        `).join('');
                    }
                });
            });

            // Also highlight difficulty justification spans
            const activeJustification = getActiveDifficultyJustification();
            difficultyJustifications.forEach((data, key) => {
                const color = difficultyLabels[key].color;
                ['premise', 'hypothesis'].forEach(source => {
                    data.spans[source].forEach(wordIdx => {
                        const wordEl = document.querySelector(
                            `.word[data-source="${source}"][data-index="${wordIdx}"]`
                        );
                        const dotsEl = document.querySelector(
                            `.label-dots[data-source="${source}"][data-index="${wordIdx}"]`
                        );

                        if (wordEl) {
                            // Add visual indicator for difficulty justification
                            if (key === activeJustification) {
                                wordEl.style.borderColor = color;
                                wordEl.style.borderWidth = '2px';
                                wordEl.style.borderStyle = 'dashed';
                                wordEl.style.background = `${color}20`;  // 20 = 12% opacity in hex
                            }
                        }

                        if (dotsEl) {
                            // Add a square marker (not dot) to distinguish from regular labels
                            const marker = document.createElement('div');
                            marker.className = 'label-dot';
                            marker.style.background = color;
                            marker.style.borderRadius = '2px';  // Square-ish
                            marker.title = `${key.replace(/_/g, ' ')} justification`;
                            if (key === activeJustification) {
                                marker.classList.add('active-label');
                            }
                            dotsEl.appendChild(marker);
                        }
                    });
                });
            });
        }

        function clearSelections() {
            labels.forEach(label => {
                label.spans = { premise: new Set(), hypothesis: new Set() };
            });
            activeLabel = null;
            // Also clear difficulty justifications
            difficultyJustifications.clear();
            renderDifficultyJustifications();
            renderLabels();
            updateWordHighlights();
            showMessage('Cleared all selections', 'success');
        }

        // ============================================================================
        // Save / Skip
        // ============================================================================

        async function saveAndNext() {
            if (!currentExample) return;

            const labelData = labels
                .filter(l => l.spans.premise.size > 0 || l.spans.hypothesis.size > 0)
                .map(l => ({
                    label_name: l.name,
                    label_color: l.color,
                    spans: [
                        ...Array.from(l.spans.premise).map(idx => {
                            const wordData = currentExample.premise_words[idx];
                            return {
                                source: 'premise',
                                word_index: idx,
                                word_text: wordData.text,
                                char_start: wordData.char_start,
                                char_end: wordData.char_end
                            };
                        }),
                        ...Array.from(l.spans.hypothesis).map(idx => {
                            const wordData = currentExample.hypothesis_words[idx];
                            return {
                                source: 'hypothesis',
                                word_index: idx,
                                word_text: wordData.text,
                                char_start: wordData.char_start,
                                char_end: wordData.char_end
                            };
                        })
                    ]
                }));

            const complexityScores = {};
            complexityDimensions.forEach(dim => {
                const numInput = document.getElementById(`complexity-num-${dim.key}`);
                if (numInput) {
                    complexityScores[dim.key] = parseInt(numInput.value) || 0;
                }
            });

            // Build difficulty justification spans
            const difficultyJustificationData = {};
            difficultyJustifications.forEach((data, key) => {
                if (data.spans.premise.size > 0 || data.spans.hypothesis.size > 0) {
                    difficultyJustificationData[key] = {
                        spans: [
                            ...Array.from(data.spans.premise).map(idx => {
                                const wordData = currentExample.premise_words[idx];
                                return {
                                    source: 'premise',
                                    word_index: idx,
                                    word_text: wordData.text,
                                    char_start: wordData.char_start,
                                    char_end: wordData.char_end
                                };
                            }),
                            ...Array.from(data.spans.hypothesis).map(idx => {
                                const wordData = currentExample.hypothesis_words[idx];
                                return {
                                    source: 'hypothesis',
                                    word_index: idx,
                                    word_text: wordData.text,
                                    char_start: wordData.char_start,
                                    char_end: wordData.char_end
                                };
                            })
                        ]
                    };
                }
            });

            try {
                const resp = await authenticatedFetch('/api/label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        example_id: currentExample.id,
                        labels: labelData,
                        complexity_scores: complexityScores,
                        difficulty_justifications: difficultyJustificationData
                    })
                });

                if (resp.ok) {
                    showMessage('Saved successfully!', 'success');
                    loadNextExample();
                } else {
                    const err = await resp.json();
                    showMessage(`Error: ${err.detail}`, 'error');
                }
            } catch (e) {
                showMessage(`Error saving: ${e.message}`, 'error');
            }
        }

        async function skipExample() {
            if (!currentExample) return;
            try {
                await authenticatedFetch(`/api/skip/${currentExample.id}`, { method: 'POST' });
                showMessage('Skipped', 'success');
                loadNextExample();
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        // ============================================================================
        // Flagging Functions
        // ============================================================================

        function showFlagModal() {
            if (!currentExample) {
                showMessage('No example loaded', 'error');
                return;
            }
            document.getElementById('flag-reason').value = '';
            const modal = document.getElementById('flag-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.getElementById('flag-reason').focus();
        }

        function closeFlagModal() {
            const modal = document.getElementById('flag-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        async function submitFlag() {
            const reason = document.getElementById('flag-reason').value.trim();
            if (!reason) {
                showMessage('Please provide a reason for flagging', 'error');
                return;
            }
            if (!currentExample) {
                showMessage('No example loaded', 'error');
                return;
            }

            try {
                const resp = await authenticatedFetch('/api/flag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        example_id: currentExample.id,
                        reason: reason
                    })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Failed to flag example');
                }

                closeFlagModal();
                showMessage('Example flagged for review', 'success');
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        // Close flag modal on escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const flagModal = document.getElementById('flag-modal');
                if (flagModal && !flagModal.classList.contains('hidden')) {
                    closeFlagModal();
                }
            }
        });

        // Close flag modal on backdrop click
        document.getElementById('flag-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFlagModal();
            }
        });

        // ============================================================================
        // UI Helpers
        // ============================================================================

        function showMessage(text, type) {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => { area.innerHTML = ''; }, 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');

            // Tab-specific loading handlers
            if (tabName === 'stats') loadStats();
            if (tabName === 'admin' && typeof loadAdminDashboard === 'function') loadAdminDashboard();
            if (tabName === 'gold-examples' && typeof loadGoldExamples === 'function') loadGoldExamples();
            if (tabName === 'flagged' && typeof loadFlaggedExamples === 'function') loadFlaggedExamples();
        }

        async function loadStats() {
            const content = document.getElementById('stats-content');
            content.innerHTML = '<div class="loading">Loading stats...</div>';

            try {
                const resp = await authenticatedFetch('/api/stats');
                const stats = await resp.json();

                // Render personal stats card
                renderPersonalStats(stats);

                // Compute total labeled from per-dataset counts
                const totalLabeled = Object.values(stats.labeled).reduce((sum, n) => sum + n, 0);

                // Render general stats
                let html = `
                    <div class="stat-card">
                        <div class="stat-label">Total Labeled</div>
                        <div class="stat-value">${totalLabeled}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Spans</div>
                        <div class="stat-value">${stats.spans.total_spans}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Examples with Spans</div>
                        <div class="stat-value">${stats.spans.examples_with_spans}</div>
                    </div>
                `;

                Object.entries(stats.datasets).forEach(([ds, info]) => {
                    const labeled = stats.labeled[ds] || 0;
                    const skipped = stats.skipped[ds] || 0;
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">${ds}</div>
                            <div class="stat-value">${labeled}/${info.total}</div>
                            <div style="font-size: 0.8rem; color: #aaa;">${skipped} skipped</div>
                        </div>
                    `;
                });

                if (stats.complexity_averages) {
                    html += '<div style="grid-column: 1 / -1; margin-top: 20px;"><h4>Average Complexity Scores</h4></div>';
                    Object.entries(stats.complexity_averages).forEach(([key, val]) => {
                        if (val !== null) {
                            html += `
                                <div class="stat-card">
                                    <div class="stat-label">${key}</div>
                                    <div class="stat-value">${val.toFixed(1)}</div>
                                </div>
                            `;
                        }
                    });
                }

                if (Object.keys(stats.label_distribution).length > 0) {
                    html += '<div style="grid-column: 1 / -1; margin-top: 20px;"><h4>Label Distribution</h4></div>';
                    Object.entries(stats.label_distribution).forEach(([name, data]) => {
                        const count = typeof data === 'object' ? data.count : data;
                        html += `
                            <div class="stat-card">
                                <div class="stat-label">${name}</div>
                                <div class="stat-value">${count}</div>
                            </div>
                        `;
                    });
                }

                content.innerHTML = html;

                // Render leaderboard
                renderLeaderboard(stats.annotators || []);
            } catch (e) {
                content.innerHTML = `<div class="message error">Error loading stats: ${e.message}</div>`;
            }
        }

        async function renderPersonalStats(stats) {
            const card = document.getElementById('personal-stats-card');
            const grid = document.getElementById('personal-stats-grid');

            if (!stats.user_stats || !currentUser || currentUser.is_anonymous) {
                card.classList.add('hidden');
                return;
            }

            card.classList.remove('hidden');

            // Calculate user's rank
            const annotators = stats.annotators || [];
            const sortedAnnotators = [...annotators].sort((a, b) => b.labeled - a.labeled);
            const userRank = sortedAnnotators.findIndex(a => a.username === currentUser.username) + 1;
            const totalAnnotators = sortedAnnotators.length;

            grid.innerHTML = `
                <div class="personal-stat-item">
                    <div class="personal-stat-value rank">#${userRank || 'â€”'}</div>
                    <div class="personal-stat-label">Rank</div>
                    <div class="personal-stat-sublabel">of ${totalAnnotators} annotators</div>
                </div>
                <div class="personal-stat-item">
                    <div class="personal-stat-value">${stats.user_stats.labeled}</div>
                    <div class="personal-stat-label">Annotations</div>
                </div>
                <div class="personal-stat-item">
                    <div class="personal-stat-value">${stats.user_stats.skipped}</div>
                    <div class="personal-stat-label">Skipped</div>
                </div>
            `;

            // Fetch reliability score separately
            try {
                const reliabilityResp = await fetch('/api/reliability/me');
                if (reliabilityResp.ok) {
                    const reliability = await reliabilityResp.json();
                    const reliabilityDisplay = reliability.calibration_status === 'calibrated' && reliability.reliability_score !== null
                        ? Math.round(reliability.reliability_score)
                        : null;
                    const reliabilitySublabel = reliability.calibration_status === 'provisional'
                        ? `${reliability.scored_annotation_count}/${reliability.calibration_threshold} calibrating`
                        : 'calibrated';

                    grid.innerHTML += `
                        <div class="personal-stat-item">
                            <div class="personal-stat-value" style="${reliabilityDisplay === null ? 'color: var(--text-secondary); font-size: 1.2rem;' : ''}">${reliabilityDisplay !== null ? reliabilityDisplay : 'â€”'}</div>
                            <div class="personal-stat-label">Reliability</div>
                            <div class="personal-stat-sublabel">${reliabilitySublabel}</div>
                        </div>
                    `;
                } else {
                    grid.innerHTML += `
                        <div class="personal-stat-item">
                            <div class="personal-stat-value" style="color: var(--text-secondary); font-size: 1.2rem;">â€”</div>
                            <div class="personal-stat-label">Reliability</div>
                            <div class="personal-stat-sublabel">provisional</div>
                        </div>
                    `;
                }
            } catch (e) {
                grid.innerHTML += `
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: var(--text-secondary); font-size: 1.2rem;">â€”</div>
                        <div class="personal-stat-label">Reliability</div>
                        <div class="personal-stat-sublabel">error</div>
                    </div>
                `;
            }
        }

        async function renderLeaderboard(fallbackAnnotators) {
            const content = document.getElementById('leaderboard-content');

            // Try to fetch leaderboard with reliability scores
            let leaderboardEntries = null;
            let calibrationThreshold = 5;

            try {
                const resp = await fetch('/api/reliability/leaderboard?sort_by=annotations');
                if (resp.ok) {
                    const data = await resp.json();
                    leaderboardEntries = data.entries;
                    calibrationThreshold = data.calibration_threshold;
                }
            } catch (e) {
                console.warn('Could not fetch reliability leaderboard, using fallback:', e);
            }

            // Use fallback if API failed
            const annotators = leaderboardEntries || fallbackAnnotators || [];

            if (annotators.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary);">No annotators yet.</p>';
                return;
            }

            // Store data for sorting (map to consistent format)
            leaderboardData = annotators.map(a => ({
                username: a.username,
                display_name: a.display_name,
                labeled: a.annotations !== undefined ? a.annotations : a.labeled,
                reliability_score: a.reliability_score,
                calibration_status: a.calibration_status || 'provisional',
                is_current_user: a.is_current_user,
                role: a.role
            }));

            // Sort data
            const sortedData = sortLeaderboardData();

            // Build table
            let html = `
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortLeaderboard('rank')">Rank</th>
                            <th onclick="sortLeaderboard('username')" class="${leaderboardSortColumn === 'username' ? 'sorted-' + leaderboardSortDirection : ''}">User</th>
                            <th onclick="sortLeaderboard('labeled')" class="${leaderboardSortColumn === 'labeled' ? 'sorted-' + leaderboardSortDirection : ''}">Annotations</th>
                            <th onclick="sortLeaderboard('reliability')" class="${leaderboardSortColumn === 'reliability' ? 'sorted-' + leaderboardSortDirection : ''}">Reliability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedData.forEach((annotator, index) => {
                const rank = index + 1;
                const isCurrentUser = annotator.is_current_user || (currentUser && annotator.username === currentUser.username);
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const displayName = annotator.display_name || annotator.username;
                const roleBadge = annotator.role === 'admin' ? '<span class="role-badge admin">Admin</span>' : '';

                // Format reliability display
                let reliabilityDisplay = 'â€”';
                let reliabilityClass = '';
                if (annotator.calibration_status === 'calibrated' && annotator.reliability_score !== null) {
                    reliabilityDisplay = Math.round(annotator.reliability_score);
                    // Color code: green for high, yellow for medium, red for low
                    if (annotator.reliability_score >= 80) reliabilityClass = 'reliability-high';
                    else if (annotator.reliability_score >= 60) reliabilityClass = 'reliability-medium';
                    else reliabilityClass = 'reliability-low';
                } else if (annotator.calibration_status === 'provisional') {
                    reliabilityDisplay = '<span style="font-size: 0.8em; opacity: 0.7;">calibrating</span>';
                }

                html += `
                    <tr class="${isCurrentUser ? 'current-user' : ''}">
                        <td class="rank-cell ${rankClass}">${rank}</td>
                        <td>
                            <div class="user-cell">
                                <span class="display-name">${displayName}</span>
                                ${displayName !== annotator.username ? `<span class="username">@${annotator.username}</span>` : ''}
                                ${roleBadge}
                            </div>
                        </td>
                        <td class="score-cell">${annotator.labeled}</td>
                        <td class="reliability-cell ${reliabilityClass}">${reliabilityDisplay}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            content.innerHTML = html;
        }

        function sortLeaderboardData() {
            const data = [...leaderboardData];

            data.sort((a, b) => {
                let aVal, bVal;

                switch (leaderboardSortColumn) {
                    case 'username':
                        aVal = (a.display_name || a.username).toLowerCase();
                        bVal = (b.display_name || b.username).toLowerCase();
                        break;
                    case 'reliability':
                        // Calibrated with score > provisional > null
                        // Use -1 for provisional/null so they sort last when descending
                        aVal = (a.calibration_status === 'calibrated' && a.reliability_score !== null) ? a.reliability_score : -1;
                        bVal = (b.calibration_status === 'calibrated' && b.reliability_score !== null) ? b.reliability_score : -1;
                        break;
                    case 'labeled':
                    default:
                        aVal = a.labeled;
                        bVal = b.labeled;
                        break;
                }

                if (aVal < bVal) return leaderboardSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return leaderboardSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return data;
        }

        function sortLeaderboard(column) {
            if (column === 'rank') {
                // Rank always sorts by labeled desc
                leaderboardSortColumn = 'labeled';
                leaderboardSortDirection = 'desc';
            } else if (leaderboardSortColumn === column) {
                // Toggle direction
                leaderboardSortDirection = leaderboardSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                leaderboardSortColumn = column;
                // Default to descending for numeric columns, ascending for username
                leaderboardSortDirection = (column === 'labeled' || column === 'reliability') ? 'desc' : 'asc';
            }

            renderLeaderboard(leaderboardData);
        }

        async function lookupExample() {
            const dataset = document.getElementById('lookup-dataset').value.trim();
            const id = document.getElementById('lookup-id').value.trim();
            const resultArea = document.getElementById('lookup-result');

            if (!id) {
                resultArea.innerHTML = '<div class="message error">Please enter an example ID</div>';
                return;
            }

            try {
                const url = dataset ? `/api/example/${dataset}/${id}` : `/api/example/unknown/${id}`;
                const resp = await authenticatedFetch(url);

                if (!resp.ok) {
                    const err = await resp.json();
                    resultArea.innerHTML = `<div class="message error">${err.detail}</div>`;
                    return;
                }

                const data = await resp.json();
                currentExample = data;
                switchTab('labeler');
                resetLabelsForNewExample();
                renderExample();
                resetFocus();

                if (data.existing_labels && data.existing_labels.length > 0) {
                    loadExistingLabels(data.existing_labels);
                }
            } catch (e) {
                resultArea.innerHTML = `<div class="message error">Error: ${e.message}</div>`;
            }
        }

        async function exportLabels() {
            try {
                const resp = await authenticatedFetch('/api/export');
                const data = await resp.json();

                const blob = new Blob(
                    [data.data.map(d => JSON.stringify(d)).join('\n')],
                    { type: 'application/jsonl' }
                );
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nli_span_labels_${new Date().toISOString().split('T')[0]}.jsonl`;
                a.click();
                URL.revokeObjectURL(url);

                showMessage(`Exported ${data.count} labeled examples`, 'success');
            } catch (e) {
                showMessage(`Export error: ${e.message}`, 'error');
            }
        }

        function showStats() { switchTab('stats'); }

        // ============================================================================
        // Admin Dashboard
        // ============================================================================

        let adminDashboardData = null;

        function updateAdminTabVisibility() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            // Handle all admin-only elements by class
            document.querySelectorAll('.admin-only').forEach(el => {
                if (isAdmin) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Also handle the original admin tab button by ID for backwards compatibility
            const adminTabBtn = document.getElementById('admin-tab-btn');
            if (adminTabBtn) {
                if (isAdmin) {
                    adminTabBtn.classList.remove('hidden');
                } else {
                    adminTabBtn.classList.add('hidden');
                }
            }
            // Initialize quality review if admin
            if (isAdmin) {
                initQualityReview();
            }
        }

        async function loadAdminDashboard() {
            if (!currentUser || currentUser.role !== 'admin') {
                return;
            }

            const dataset = document.getElementById('admin-dataset-filter').value;
            const days = document.getElementById('admin-days-filter').value;

            try {
                const params = new URLSearchParams();
                if (dataset) params.append('dataset', dataset);
                params.append('days', days);

                const resp = await fetch(`/api/admin/dashboard?${params}`);
                if (!resp.ok) {
                    throw new Error('Failed to load dashboard');
                }

                adminDashboardData = await resp.json();
                renderAdminDashboard(adminDashboardData);

                // Populate dataset filter if not already done
                const datasetFilter = document.getElementById('admin-dataset-filter');
                if (datasetFilter.options.length <= 1 && adminDashboardData.datasets) {
                    adminDashboardData.datasets.forEach(ds => {
                        const opt = document.createElement('option');
                        opt.value = ds.name;
                        opt.textContent = ds.name;
                        datasetFilter.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Admin dashboard error:', e);
                document.getElementById('admin-overview').innerHTML =
                    `<div class="message error">Failed to load dashboard: ${e.message}</div>`;
            }
        }

        function renderAdminDashboard(data) {
            // Overview cards
            const overview = data.overview;
            document.getElementById('admin-overview').innerHTML = `
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.total_annotations.toLocaleString()}</div>
                    <div class="admin-stat-label">Total Annotations</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.annotated_examples.toLocaleString()}</div>
                    <div class="admin-stat-label">Examples Annotated</div>
                    <div class="admin-stat-sublabel">${overview.completion_pct}% of ${overview.total_examples.toLocaleString()}</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.total_annotators}</div>
                    <div class="admin-stat-label">Total Annotators</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${overview.active_users_24h}</div>
                    <div class="admin-stat-label">Active (24h)</div>
                    <div class="admin-stat-sublabel">${overview.active_users_7d} in last 7d</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${data.pools.test}</div>
                    <div class="admin-stat-label">Test Pool</div>
                    <div class="admin-stat-sublabel">High consensus</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">${data.pools.building}</div>
                    <div class="admin-stat-label">Building Pool</div>
                    <div class="admin-stat-sublabel">In progress</div>
                </div>
            `;

            // Activity chart
            renderActivityChart(data.activity.daily);

            // Dataset table
            renderDatasetTable(data.datasets);

            // Quality indicators
            renderQualityIndicators(data.quality);

            // Annotator table
            renderAnnotatorTable(data.annotators);

            // Hotspots table
            renderHotspotsTable(data.quality.disagreement_hotspots);
        }

        function renderActivityChart(daily) {
            const container = document.getElementById('admin-activity-chart');

            if (!daily || daily.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; width: 100%;">No activity data</div>';
                return;
            }

            const maxCount = Math.max(...daily.map(d => d.count), 1);
            const barWidth = Math.max(4, Math.floor((container.offsetWidth - 20) / daily.length) - 2);

            container.innerHTML = daily.map(d => {
                const height = Math.max(4, (d.count / maxCount) * 180);
                return `
                    <div class="activity-bar" style="height: ${height}px; width: ${barWidth}px;">
                        <span class="activity-bar-label">${d.date}: ${d.count}</span>
                    </div>
                `;
            }).join('');
        }

        function renderDatasetTable(datasets) {
            const container = document.getElementById('admin-datasets-table');

            if (!datasets || datasets.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">No datasets</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Dataset</th>
                            <th>Progress</th>
                            <th>Annotations</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${datasets.map(ds => `
                            <tr>
                                <td><strong>${ds.name}</strong></td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${ds.completion_pct}%"></div>
                                    </div>
                                    ${ds.completion_pct}%
                                </td>
                                <td>${ds.total_annotations.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderQualityIndicators(quality) {
            const container = document.getElementById('admin-quality-indicators');

            container.innerHTML = `
                <div class="quality-stat">
                    <span class="quality-stat-label">Examples with overlap (2+ annotators)</span>
                    <span class="quality-stat-value">${quality.examples_with_overlap.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Examples at consensus threshold</span>
                    <span class="quality-stat-value">${quality.examples_at_consensus.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Custom labels used</span>
                    <span class="quality-stat-value">${quality.custom_label_usage.toLocaleString()}</span>
                </div>
                <div class="quality-stat">
                    <span class="quality-stat-label">Disagreement hotspots</span>
                    <span class="quality-stat-value" style="color: ${quality.disagreement_hotspots.length > 0 ? '#f87171' : '#4ade80'}">
                        ${quality.disagreement_hotspots.length}
                    </span>
                </div>
            `;
        }

        function renderAnnotatorTable(annotators) {
            const container = document.getElementById('admin-annotators-table');

            if (!annotators || annotators.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">No annotators</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Annotator</th>
                            <th>Role</th>
                            <th>Annotations</th>
                            <th>Reliability</th>
                            <th>Last Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${annotators.map(a => {
                            let reliabilityBadge;
                            if (a.calibration_status === 'provisional') {
                                reliabilityBadge = '<span class="reliability-badge calibrating-badge">Calibrating</span>';
                            } else if (a.reliability_score !== null) {
                                const score = Math.round(a.reliability_score);
                                let badgeClass = 'reliability-low';
                                if (score >= 80) badgeClass = 'reliability-high';
                                else if (score >= 60) badgeClass = 'reliability-medium';
                                reliabilityBadge = `<span class="reliability-badge ${badgeClass}">${score}</span>`;
                            } else {
                                reliabilityBadge = '<span style="color: var(--text-secondary);">â€”</span>';
                            }

                            const roleBadge = a.role === 'admin' ? '<span class="role-badge admin">Admin</span>' : '';
                            const lastSeen = a.last_seen ? new Date(a.last_seen).toLocaleDateString() : 'â€”';

                            return `
                                <tr>
                                    <td><strong>${a.display_name || a.username}</strong> ${roleBadge}</td>
                                    <td>${a.role}</td>
                                    <td>${a.annotations.toLocaleString()}</td>
                                    <td>${reliabilityBadge}</td>
                                    <td>${lastSeen}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderHotspotsTable(hotspots) {
            const container = document.getElementById('admin-hotspots-table');

            if (!hotspots || hotspots.length === 0) {
                container.innerHTML = '<div style="color: #4ade80; padding: 20px; text-align: center;">âœ“ No disagreement hotspots found</div>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Example ID</th>
                            <th>Dataset</th>
                            <th>Annotations</th>
                            <th>Agreement</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hotspots.map(h => `
                            <tr class="hotspot-row" onclick="lookupHotspot('${h.example_id}')">
                                <td><code>${h.example_id}</code></td>
                                <td>${h.dataset}</td>
                                <td>${h.annotation_count}</td>
                                <td style="color: #f87171">${h.agreement_score !== null ? (h.agreement_score * 100).toFixed(1) + '%' : 'â€”'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function lookupHotspot(exampleId) {
            document.getElementById('lookup-id').value = exampleId;
            switchTab('lookup');
            lookupExample();
        }

        // Update admin tab visibility when user changes
        const originalUpdateUserDisplay = updateUserDisplay;
        updateUserDisplay = function() {
            originalUpdateUserDisplay();
            updateAdminTabVisibility();
        };

        // Admin dashboard loading is now handled in switchTab()

        // ============================================================================
        // Quality Review Functions (Admin Only)
        // ============================================================================

        let reviewCurrentUser = null;
        let reviewCurrentOffset = 0;
        let reviewCurrentData = null;

        async function initQualityReview() {
            // Load users into the review dropdown
            try {
                const resp = await authenticatedFetch('/api/reliability/leaderboard?sort_by=annotations');
                if (!resp.ok) return;
                const data = await resp.json();

                const select = document.getElementById('review-user-select');
                select.innerHTML = '<option value="">Select user to review...</option>';

                for (const entry of data.entries) {
                    const opt = document.createElement('option');
                    opt.value = entry.user_id;
                    opt.textContent = `${entry.display_name || entry.username} (${entry.annotations} annotations)`;
                    select.appendChild(opt);
                }

                // Also load datasets into filter
                const dsResp = await authenticatedFetch('/api/datasets');
                if (dsResp.ok) {
                    const dsData = await dsResp.json();
                    const dsSelect = document.getElementById('review-dataset-filter');
                    dsSelect.innerHTML = '<option value="">All datasets</option>';
                    for (const ds of dsData) {
                        const opt = document.createElement('option');
                        opt.value = ds.name;
                        opt.textContent = `${ds.name} (${ds.count})`;
                        dsSelect.appendChild(opt);
                    }
                }
            } catch (e) {
                console.error('Error loading quality review data:', e);
            }
        }

        async function loadUserReview() {
            const userId = document.getElementById('review-user-select').value;
            if (!userId) {
                document.getElementById('review-user-stats').classList.add('hidden');
                document.getElementById('review-annotations-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Select a user to begin review.</p>';
                document.getElementById('review-pagination').classList.add('hidden');
                reviewCurrentUser = null;
                return;
            }

            reviewCurrentUser = userId;
            reviewCurrentOffset = 0;

            // Load user reliability stats
            try {
                const resp = await authenticatedFetch(`/api/reliability/user/${userId}`);
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('review-total-annotations').textContent = data.total_annotations;
                    document.getElementById('review-reliability').textContent = data.reliability_score !== null ? data.reliability_score.toFixed(1) : 'N/A';
                    document.getElementById('review-calibration').textContent = data.calibration_status;
                    document.getElementById('review-user-stats').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error loading user reliability:', e);
            }

            // Load disagreement count
            try {
                const resp = await authenticatedFetch(`/api/admin/user/${userId}/disagreements?limit=1`);
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('review-disagreements').textContent = data.total;
                }
            } catch (e) {
                document.getElementById('review-disagreements').textContent = '?';
            }

            // Load annotations
            await loadUserAnnotations(0);
        }

        async function loadUserAnnotations(offset = 0) {
            if (!reviewCurrentUser) return;

            reviewCurrentOffset = Math.max(0, offset);
            const dataset = document.getElementById('review-dataset-filter').value;
            const disagreementsOnly = document.getElementById('review-disagreements-only').checked;

            let url = `/api/admin/user/${reviewCurrentUser}/annotations?limit=20&offset=${reviewCurrentOffset}`;
            if (dataset) url += `&dataset=${encodeURIComponent(dataset)}`;
            if (disagreementsOnly) url += `&disagreements_only=true`;

            const listEl = document.getElementById('review-annotations-list');
            listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Loading...</p>';

            try {
                const resp = await authenticatedFetch(url);
                if (!resp.ok) {
                    listEl.innerHTML = '<p style="color: var(--error);">Error loading annotations.</p>';
                    return;
                }

                const data = await resp.json();
                reviewCurrentData = data;
                renderAnnotationsList(data);

                // Update pagination
                const pagination = document.getElementById('review-pagination');
                const pageInfo = document.getElementById('review-page-info');
                const prevBtn = document.getElementById('review-prev-btn');
                const nextBtn = document.getElementById('review-next-btn');

                if (data.total > 0) {
                    pagination.classList.remove('hidden');
                    const startNum = reviewCurrentOffset + 1;
                    const endNum = Math.min(reviewCurrentOffset + data.annotations.length, data.total);
                    pageInfo.textContent = `${startNum}-${endNum} of ${data.total}`;
                    prevBtn.disabled = reviewCurrentOffset === 0;
                    nextBtn.disabled = reviewCurrentOffset + 20 >= data.total;
                } else {
                    pagination.classList.add('hidden');
                }
            } catch (e) {
                listEl.innerHTML = `<p style="color: var(--error);">Error: ${e.message}</p>`;
            }
        }

        function renderAnnotationsList(data) {
            const listEl = document.getElementById('review-annotations-list');

            if (!data.annotations || data.annotations.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No annotations found.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

            for (const ann of data.annotations) {
                const hasDisagreement = ann.disagreement_severity && ann.disagreement_severity > 0;
                const borderColor = hasDisagreement ? '#e63946' : '#333';
                const bgColor = hasDisagreement ? 'rgba(230, 57, 70, 0.1)' : 'rgba(255,255,255,0.02)';

                // Format labels
                const userLabels = ann.user_labels ? ann.user_labels.map(l => `<span style="background: #3a86ff; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${l}</span>`).join(' ') : '<span style="color: #888;">None</span>';
                const consensusLabels = ann.consensus_labels ? ann.consensus_labels.map(l => `<span style="background: #2a9d8f; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${l}</span>`).join(' ') : '<span style="color: #888;">No consensus</span>';

                html += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 15px; cursor: pointer;" onclick='showAnnotationDetail(${JSON.stringify(ann).replace(/'/g, "\\'")})'>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-family: monospace; color: var(--text-secondary);">${ann.example_id}</span>
                        <span style="color: #888;">${ann.dataset || 'Unknown'}</span>
                    </div>
                    <div style="font-size: 13px; color: #ccc; margin-bottom: 10px; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                        <strong>P:</strong> ${escapeHtml(ann.premise?.substring(0, 100) || '')}${ann.premise?.length > 100 ? '...' : ''}<br>
                        <strong>H:</strong> ${escapeHtml(ann.hypothesis?.substring(0, 100) || '')}${ann.hypothesis?.length > 100 ? '...' : ''}
                    </div>
                    <div style="display: flex; gap: 20px; font-size: 13px;">
                        <div><strong>User:</strong> ${userLabels}</div>
                        <div><strong>Consensus:</strong> ${consensusLabels}</div>
                        ${hasDisagreement ? `<div style="color: #e63946;"><strong>âš  Disagreement</strong></div>` : ''}
                    </div>
                </div>`;
            }

            html += '</div>';
            listEl.innerHTML = html;
        }

        function showAnnotationDetail(ann) {
            const modal = document.getElementById('annotation-detail-modal');
            const content = document.getElementById('annotation-detail-content');

            // Format labels comparison
            const userLabels = ann.user_labels || [];
            const consensusLabels = ann.consensus_labels || [];
            const missingLabels = consensusLabels.filter(l => !userLabels.includes(l));
            const extraLabels = userLabels.filter(l => !consensusLabels.includes(l));
            const matchingLabels = userLabels.filter(l => consensusLabels.includes(l));

            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">Example ID</div>
                    <div style="font-family: monospace;">${ann.example_id}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">Dataset</div>
                    <div>${ann.dataset || 'Unknown'}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">Premise</div>
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">${escapeHtml(ann.premise || '')}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">Hypothesis</div>
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">${escapeHtml(ann.hypothesis || '')}</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">User's Labels</div>
                        <div style="background: rgba(58, 134, 255, 0.1); border: 1px solid #3a86ff; padding: 10px; border-radius: 6px;">
                            ${userLabels.length > 0 ? userLabels.map(l => {
                                const color = matchingLabels.includes(l) ? '#2a9d8f' : '#e63946';
                                return `<span style="background: ${color}; padding: 3px 8px; border-radius: 4px; margin: 2px; display: inline-block;">${l}</span>`;
                            }).join('') : '<span style="color: #888;">No labels</span>'}
                        </div>
                        ${ann.user_complexity !== undefined ? `<div style="margin-top: 5px; color: #888;">Complexity: ${ann.user_complexity}</div>` : ''}
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Consensus Labels</div>
                        <div style="background: rgba(42, 157, 143, 0.1); border: 1px solid #2a9d8f; padding: 10px; border-radius: 6px;">
                            ${consensusLabels.length > 0 ? consensusLabels.map(l => `<span style="background: #2a9d8f; padding: 3px 8px; border-radius: 4px; margin: 2px; display: inline-block;">${l}</span>`).join('') : '<span style="color: #888;">No consensus yet</span>'}
                        </div>
                        ${ann.consensus_complexity !== undefined ? `<div style="margin-top: 5px; color: #888;">Complexity: ${ann.consensus_complexity}</div>` : ''}
                    </div>
                </div>

                ${missingLabels.length > 0 || extraLabels.length > 0 ? `
                <div style="background: rgba(230, 57, 70, 0.1); border: 1px solid #e63946; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <div style="color: #e63946; font-weight: bold; margin-bottom: 10px;">âš  Disagreements</div>
                    ${missingLabels.length > 0 ? `<div style="margin-bottom: 5px;"><strong>Missing:</strong> ${missingLabels.map(l => `<span style="background: #e63946; padding: 2px 6px; border-radius: 3px; margin: 2px;">${l}</span>`).join('')}</div>` : ''}
                    ${extraLabels.length > 0 ? `<div><strong>Extra:</strong> ${extraLabels.map(l => `<span style="background: #f4a261; padding: 2px 6px; border-radius: 3px; margin: 2px;">${l}</span>`).join('')}</div>` : ''}
                </div>
                ` : `
                <div style="background: rgba(42, 157, 143, 0.1); border: 1px solid #2a9d8f; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <div style="color: #2a9d8f; font-weight: bold;">âœ“ Labels match consensus</div>
                </div>
                `}

                <div style="color: var(--text-secondary); font-size: 12px;">
                    Annotated: ${ann.created_at ? new Date(ann.created_at).toLocaleString() : 'Unknown'}
                </div>
            `;

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeAnnotationDetail() {
            const modal = document.getElementById('annotation-detail-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAnnotationDetail();
            }
        });

        // Close modal on backdrop click
        document.getElementById('annotation-detail-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAnnotationDetail();
            }
        });

        // ============================================================================
        // Training Mode Functions
        // ============================================================================

        let trainingExample = null;
        let trainingComplexityScores = {};
        let trainingProgress = { completed: 0, required: 5 };

        async function checkTrainingStatus() {
            try {
                const response = await fetch('/api/training/status');
                if (!response.ok) return;

                const data = await response.json();
                if (data.training_enabled && data.training_required && data.available_gold_examples >= data.required) {
                    trainingProgress.completed = data.completed;
                    trainingProgress.required = data.required;
                    showTrainingMode();
                }
            } catch (e) {
                console.error('Failed to check training status:', e);
            }
        }

        function showTrainingMode() {
            document.getElementById('training-overlay').classList.remove('hidden');
            document.getElementById('training-required-count').textContent = trainingProgress.required;
            updateTrainingProgress();
            loadNextTrainingExample();
        }

        function hideTrainingMode() {
            document.getElementById('training-overlay').classList.add('hidden');
        }

        function updateTrainingProgress() {
            const pct = (trainingProgress.completed / trainingProgress.required) * 100;
            document.getElementById('training-progress-bar').style.width = pct + '%';
            document.getElementById('training-progress-text').textContent =
                `${trainingProgress.completed} / ${trainingProgress.required} completed`;
        }

        async function loadNextTrainingExample() {
            const area = document.getElementById('training-example-area');
            area.innerHTML = '<div class="loading">Loading training example...</div>';

            // Hide feedback panel
            document.getElementById('training-feedback').classList.add('hidden');
            document.getElementById('training-complete').classList.add('hidden');

            try {
                const response = await fetch('/api/training/next');
                const data = await response.json();

                if (data.training_complete) {
                    showTrainingComplete(data);
                    return;
                }

                trainingExample = data.example;
                renderTrainingExample(data.example);
                initTrainingComplexityScores();
            } catch (e) {
                area.innerHTML = '<div class="error">Failed to load training example: ' + e.message + '</div>';
            }
        }

        function renderTrainingExample(example) {
            const area = document.getElementById('training-example-area');
            area.innerHTML = `
                <div class="example-header">
                    <span class="example-id">${example.dataset} / ${example.id}</span>
                    ${example.gold_label ? `<span class="gold-label" style="background: var(--accent); color: white;">${example.gold_label}</span>` : ''}
                </div>
                <div class="text-pair">
                    <div class="text-block">
                        <div class="text-label">Premise</div>
                        <div class="text-content">${example.premise}</div>
                    </div>
                    <div class="text-block">
                        <div class="text-label">Hypothesis</div>
                        <div class="text-content">${example.hypothesis}</div>
                    </div>
                </div>
            `;
        }

        function initTrainingComplexityScores() {
            trainingComplexityScores = {
                reasoning: 0,
                creativity: 0,
                domain_knowledge: 0,
                contextual: 0,
                constraints: 0,
                ambiguity: 0
            };

            const grid = document.getElementById('training-complexity-grid');
            const dimensions = [
                { key: 'reasoning', label: 'Reasoning', desc: 'Logical inference required' },
                { key: 'creativity', label: 'Creativity', desc: 'Imaginative interpretation' },
                { key: 'domain_knowledge', label: 'Domain Knowledge', desc: 'Specialized expertise' },
                { key: 'contextual', label: 'Contextual', desc: 'Implicit context' },
                { key: 'constraints', label: 'Constraints', desc: 'Multiple conditions' },
                { key: 'ambiguity', label: 'Ambiguity', desc: 'Answer is debatable' }
            ];

            grid.innerHTML = dimensions.map(d => `
                <div class="complexity-item">
                    <label title="${d.desc}">${d.label}</label>
                    <input type="range" min="0" max="10" value="0"
                           oninput="updateTrainingScore('${d.key}', this.value)">
                    <span class="score-value" id="training-score-${d.key}">0</span>
                </div>
            `).join('');
        }

        function updateTrainingScore(key, value) {
            trainingComplexityScores[key] = parseInt(value);
            document.getElementById(`training-score-${key}`).textContent = value;
        }

        async function submitTrainingAnnotation() {
            if (!trainingExample) return;

            try {
                const response = await fetch('/api/training/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        example_id: trainingExample.id,
                        complexity_scores: trainingComplexityScores,
                        labels: []
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.detail);

                trainingProgress.completed = data.progress.completed;
                updateTrainingProgress();
                showTrainingFeedback(data);
            } catch (e) {
                alert('Failed to submit: ' + e.message);
            }
        }

        function showTrainingFeedback(data) {
            const feedback = document.getElementById('training-feedback');
            feedback.classList.remove('hidden');

            // Set accuracy badge
            const accuracyBadge = document.getElementById('feedback-accuracy');
            accuracyBadge.textContent = data.accuracy + '%';
            accuracyBadge.className = 'accuracy-badge';
            if (data.accuracy >= 80) accuracyBadge.classList.add('good');
            else if (data.accuracy >= 50) accuracyBadge.classList.add('fair');
            else accuracyBadge.classList.add('poor');

            // Render score comparison
            const yourScores = document.getElementById('feedback-your-scores');
            const goldScores = document.getElementById('feedback-gold-scores');

            const dimensions = ['reasoning', 'creativity', 'domain_knowledge', 'contextual', 'constraints', 'ambiguity'];

            yourScores.innerHTML = dimensions.map(d => {
                const yours = data.feedback.your_scores[d] || 0;
                const gold = data.feedback.gold_scores[d] || 0;
                const diff = Math.abs(yours - gold);
                const cls = diff <= 10 ? 'match' : diff <= 25 ? 'close' : 'off';
                return `<div class="feedback-score-row ${cls}"><span>${d.replace('_', ' ')}</span><span>${yours}</span></div>`;
            }).join('');

            goldScores.innerHTML = dimensions.map(d => {
                const gold = data.feedback.gold_scores[d] || 0;
                return `<div class="feedback-score-row"><span>${d.replace('_', ' ')}</span><span>${gold}</span></div>`;
            }).join('');

            // Show explanation
            const explanation = document.getElementById('feedback-explanation');
            if (data.feedback.explanation) {
                explanation.innerHTML = `<strong>Explanation:</strong> ${data.feedback.explanation}`;
                explanation.style.display = 'block';
            } else {
                explanation.style.display = 'none';
            }

            // Check if training complete
            if (data.progress.training_complete) {
                document.querySelector('#training-feedback .btn-primary').textContent = 'Finish Training';
            }
        }

        function continueTraining() {
            if (trainingProgress.completed >= trainingProgress.required) {
                showTrainingComplete({ completed: trainingProgress.completed, required: trainingProgress.required });
            } else {
                loadNextTrainingExample();
            }
        }

        function showTrainingComplete(data) {
            document.getElementById('training-example-area').style.display = 'none';
            document.querySelector('.training-overlay .labels-section').style.display = 'none';
            document.querySelector('.training-overlay .complexity-section').style.display = 'none';
            document.querySelector('.training-overlay .actions').style.display = 'none';
            document.getElementById('training-feedback').classList.add('hidden');
            document.getElementById('training-complete').classList.remove('hidden');

            // Get final accuracy
            fetch('/api/training/progress')
                .then(r => r.json())
                .then(progress => {
                    document.getElementById('training-final-accuracy').textContent =
                        (progress.average_accuracy || 0) + '%';
                });
        }

        function finishTraining() {
            hideTrainingMode();
            loadNextExample();
        }

        // ============================================================================
        // Gold Examples Admin Functions
        // ============================================================================

        async function loadGoldExamples() {
            try {
                const response = await fetch('/api/admin/gold');
                if (!response.ok) throw new Error('Failed to load gold examples');

                const data = await response.json();
                document.getElementById('gold-count').textContent = data.total;
                document.getElementById('gold-required').textContent = data.training_min_examples;

                const list = document.getElementById('gold-examples-list');
                if (data.gold_examples.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary);">No gold examples configured yet.</p>';
                    return;
                }

                list.innerHTML = data.gold_examples.map(ex => `
                    <div class="gold-example-card">
                        <div class="example-text">
                            <strong>Premise:</strong> ${ex.premise}<br>
                            <strong>Hypothesis:</strong> ${ex.hypothesis}
                        </div>
                        <div class="gold-scores">
                            ${Object.entries(ex.gold_complexity_scores).map(([k, v]) =>
                                `<span class="gold-score-chip">${k}: ${v}</span>`
                            ).join('')}
                        </div>
                        ${ex.explanation ? `<div class="explanation">${ex.explanation}</div>` : ''}
                        <div style="margin-top: 10px;">
                            <button class="btn btn-danger btn-small" onclick="removeGoldExample('${ex.example_id}')">Remove Gold Status</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('gold-examples-list').innerHTML =
                    '<p style="color: var(--danger);">Failed to load gold examples: ' + e.message + '</p>';
            }
        }

        async function removeGoldExample(exampleId) {
            if (!confirm('Remove gold status from this example?')) return;

            try {
                const response = await fetch(`/api/admin/gold/${exampleId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to remove gold status');

                loadGoldExamples();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Gold examples loading is now handled in switchTab()
        // Training status check is now handled in initializeApp()

        // ============================================================================
        // Flagged Examples Functions (Admin Only)
        // ============================================================================

        let flaggedCurrentOffset = 0;
        let flaggedCurrentData = null;
        let currentFlagId = null;

        async function loadFlaggedExamples(offset = 0) {
            flaggedCurrentOffset = Math.max(0, offset);
            const status = document.getElementById('flagged-status-filter').value;
            const source = document.getElementById('flagged-source-filter').value;

            let url = `/api/admin/flagged?limit=50&offset=${flaggedCurrentOffset}`;
            if (status) url += `&status=${status}`;
            if (source) url += `&source=${source}`;

            const listEl = document.getElementById('flagged-list');
            listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Loading...</p>';

            try {
                const resp = await authenticatedFetch(url);
                if (!resp.ok) {
                    listEl.innerHTML = '<p style="color: var(--error);">Error loading flagged examples.</p>';
                    return;
                }

                const data = await resp.json();
                flaggedCurrentData = data;

                // Update stats
                document.getElementById('flagged-total').textContent = data.stats.total;
                document.getElementById('flagged-pending').textContent = data.stats.pending;
                document.getElementById('flagged-auto').textContent = data.stats.auto_flagged;
                document.getElementById('flagged-manual').textContent = data.stats.manual_flagged;

                // Render list
                renderFlaggedList(data);

                // Update pagination
                const pagination = document.getElementById('flagged-pagination');
                const pageInfo = document.getElementById('flagged-page-info');
                const prevBtn = document.getElementById('flagged-prev-btn');
                const nextBtn = document.getElementById('flagged-next-btn');

                if (data.total > 0) {
                    pagination.classList.remove('hidden');
                    const startNum = flaggedCurrentOffset + 1;
                    const endNum = Math.min(flaggedCurrentOffset + data.flagged.length, data.total);
                    pageInfo.textContent = `${startNum}-${endNum} of ${data.total}`;
                    prevBtn.disabled = flaggedCurrentOffset === 0;
                    nextBtn.disabled = flaggedCurrentOffset + 50 >= data.total;
                } else {
                    pagination.classList.add('hidden');
                }
            } catch (e) {
                listEl.innerHTML = `<p style="color: var(--error);">Error: ${e.message}</p>`;
            }
        }

        function renderFlaggedList(data) {
            const listEl = document.getElementById('flagged-list');

            if (!data.flagged || data.flagged.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No flagged examples found.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

            for (const flag of data.flagged) {
                const isAuto = flag.flag_source === 'auto';
                const statusColors = {
                    pending: '#f4a261',
                    reviewed: '#3a86ff',
                    resolved: '#2a9d8f',
                    excluded: '#888'
                };
                const statusColor = statusColors[flag.status] || '#888';

                html += `
                <div style="background: rgba(255,255,255,0.02); border: 1px solid #333; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="showFlagDetail(${flag.id})">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <span style="font-family: monospace; color: var(--text-secondary);">${flag.example_id}</span>
                        <div style="display: flex; gap: 10px;">
                            <span style="background: ${isAuto ? '#e63946' : '#3a86ff'}; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${isAuto ? 'Auto' : 'Manual'}</span>
                            <span style="background: ${statusColor}; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${flag.status}</span>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #ccc; margin-bottom: 10px;">
                        <strong>Reason:</strong> ${escapeHtml(flag.flag_reason || 'No reason provided')}
                    </div>
                    <div style="font-size: 12px; color: #888;">
                        ${flag.flagger_username ? `Flagged by ${flag.flagger_username}` : 'System flagged'} â€¢ ${flag.dataset || 'Unknown dataset'} â€¢ ${new Date(flag.flagged_at).toLocaleDateString()}
                        ${flag.agreement_score !== null ? ` â€¢ Agreement: ${(flag.agreement_score * 100).toFixed(0)}%` : ''}
                    </div>
                </div>`;
            }

            html += '</div>';
            listEl.innerHTML = html;
        }

        async function showFlagDetail(flagId) {
            currentFlagId = flagId;
            try {
                const resp = await authenticatedFetch(`/api/admin/flagged/${flagId}`);
                if (!resp.ok) {
                    showMessage('Error loading flag details', 'error');
                    return;
                }

                const data = await resp.json();
                const flag = data.flag;
                const annotations = data.annotations;

                const content = document.getElementById('flag-detail-content');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Example ID</div>
                        <div style="font-family: monospace;">${flag.example_id}</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: var(--text-secondary); margin-bottom: 5px;">Status</div>
                            <div>${flag.status}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); margin-bottom: 5px;">Source</div>
                            <div>${flag.flag_source === 'auto' ? 'Auto-flagged' : 'Manual'}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Reason</div>
                        <div style="background: rgba(230, 57, 70, 0.1); border: 1px solid #e63946; padding: 10px; border-radius: 6px;">
                            ${escapeHtml(flag.flag_reason || 'No reason provided')}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Premise</div>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">${escapeHtml(flag.premise || '')}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Hypothesis</div>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">${escapeHtml(flag.hypothesis || '')}</div>
                    </div>

                    ${annotations.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 10px;">Annotations (${annotations.length})</div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${annotations.map(a => `
                                <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                    <strong>${a.display_name || a.username}</strong>:
                                    ${a.labels ? a.labels.split(',').map(l => `<span style="background: #3a86ff; padding: 2px 6px; border-radius: 3px; margin: 2px; font-size: 12px;">${l}</span>`).join('') : '<span style="color: #888;">No labels</span>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${flag.resolution ? `
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Resolution</div>
                        <div style="background: rgba(42, 157, 143, 0.1); border: 1px solid #2a9d8f; padding: 10px; border-radius: 6px;">
                            ${escapeHtml(flag.resolution)}
                        </div>
                    </div>
                    ` : ''}
                `;

                // Update actions based on status
                const actions = document.getElementById('flag-detail-actions');
                if (flag.status === 'pending') {
                    actions.innerHTML = `
                        <button class="btn btn-secondary" onclick="updateFlagStatus(${flagId}, 'reviewed')">Mark Reviewed</button>
                        <button class="btn btn-success" onclick="promptResolution(${flagId}, 'resolved')">Resolve</button>
                        <button class="btn" style="background: #888; color: white;" onclick="promptResolution(${flagId}, 'excluded')">Exclude from Export</button>
                    `;
                } else if (flag.status === 'reviewed') {
                    actions.innerHTML = `
                        <button class="btn btn-success" onclick="promptResolution(${flagId}, 'resolved')">Resolve</button>
                        <button class="btn" style="background: #888; color: white;" onclick="promptResolution(${flagId}, 'excluded')">Exclude from Export</button>
                        <button class="btn btn-secondary" onclick="updateFlagStatus(${flagId}, 'pending')">Back to Pending</button>
                    `;
                } else {
                    actions.innerHTML = `
                        <button class="btn btn-secondary" onclick="updateFlagStatus(${flagId}, 'pending')">Reopen</button>
                    `;
                }

                const modal = document.getElementById('flag-detail-modal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        function closeFlagDetailModal() {
            const modal = document.getElementById('flag-detail-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentFlagId = null;
        }

        async function updateFlagStatus(flagId, status, resolution = null) {
            try {
                const resp = await authenticatedFetch(`/api/admin/flagged/${flagId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, resolution })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Failed to update status');
                }

                showMessage(`Status updated to ${status}`, 'success');
                closeFlagDetailModal();
                loadFlaggedExamples(flaggedCurrentOffset);
            } catch (e) {
                showMessage(`Error: ${e.message}`, 'error');
            }
        }

        function promptResolution(flagId, status) {
            const resolution = prompt('Enter resolution notes (optional):');
            if (resolution !== null) {
                updateFlagStatus(flagId, status, resolution || null);
            }
        }

        // Flagged examples loading is now handled in switchTab()

        // Close flag detail modal on escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('flag-detail-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeFlagDetailModal();
                }
            }
        });

        // Close flag detail modal on backdrop click
        document.getElementById('flag-detail-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFlagDetailModal();
            }
        });
    </script>
</body>
</html>
